<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Claim ETH & Riwayat Pemenang</title>
    <script src="https://cdn.jsdelivr.net/npm/web3@latest/dist/web3.min.js"></script>
    <link rel="stylesheet" href="style.css">
    <style>
        body {
    font-family: Arial, sans-serif;
    text-align: center;
    margin: 20px;
}

button {
    margin: 5px;
    padding: 10px;
    cursor: pointer;
}

.success {
    color: green;
    font-weight: bold;
}

.error {
    color: red;
    font-weight: bold;
}

table {
    width: 80%;
    margin: 20px auto;
    border-collapse: collapse;
}

th, td {
    border: 1px solid black;
    padding: 8px;
    text-align: center;
}

th {
    background-color: #f2f2f2;
}
    </style>
</head>
<body>
    <h2>üîó Wallet Connection</h2>
    <button id="connectWallet">Connect Wallet</button>
    <button id="disconnectWallet" disabled>Disconnect Wallet</button>
    <p id="walletAddress">Wallet: Not Connected</p>

    <h2>üí∞ Claim ETH</h2>
    <button id="checkEligible" onclick="checkEligibility()">Check Eligible</button>
    <p id="status"></p>
    <p id="ethAmount"></p>
    <button id="claimBtn" onclick="claimETH()" disabled>Claim ETH</button>

    <h2>üèÜ Riwayat Pemenang</h2>
    <button id="refreshWinners" onclick="getWinners()">Refresh Riwayat</button>
    <table>
        <thead>
            <tr>
                <th>No. Bet</th>
                <th>Alamat</th>
                <th>Jumlah Bet</th>
                <th>Jumlah ETH</th>
                <th>Waktu (UTC)</th>
            </tr>
        </thead>
        <tbody id="winnersList"></tbody>
    </table>

    <script src="script.js"></script>
    <script>
        const contractAddress = "0x123456789abcdef"; // Ganti dengan alamat kontrak
const contractABI = [ /* ABI dari kontrak */ ];

let web3;
let contract;
let userAccount = null;

// üîó Koneksi Wallet
document.getElementById("connectWallet").addEventListener("click", async () => {
    if (window.ethereum) {
        try {
            web3 = new Web3(window.ethereum);
            await window.ethereum.request({ method: "eth_requestAccounts" });
            const accounts = await web3.eth.getAccounts();
            userAccount = accounts[0];

            document.getElementById("walletAddress").innerText = `Wallet: ${userAccount}`;
            document.getElementById("connectWallet").disabled = true;
            document.getElementById("disconnectWallet").disabled = false;

            contract = new web3.eth.Contract(contractABI, contractAddress);
        } catch (error) {
            console.error("User denied wallet connection:", error);
            alert("Gagal terhubung ke wallet. Pastikan Anda memberi izin di MetaMask.");
        }
    } else {
        alert("MetaMask tidak terdeteksi. Silakan instal MetaMask.");
    }
});

// ‚ùå Diskoneksi Wallet
document.getElementById("disconnectWallet").addEventListener("click", () => {
    userAccount = null;
    document.getElementById("walletAddress").innerText = "Wallet: Not Connected";
    document.getElementById("connectWallet").disabled = false;
    document.getElementById("disconnectWallet").disabled = true;
});

// ‚úÖ Cek Kelayakan Klaim
async function checkEligibility() {
    if (!contract || !userAccount) {
        alert("Harap sambungkan wallet terlebih dahulu.");
        return;
    }

    try {
        let winnings = await contract.methods.winnings(userAccount).call();
        winnings = web3.utils.fromWei(winnings, "ether");

        if (winnings > 0) {
            document.getElementById("status").innerHTML = "‚úÖ Selamat, Anda bisa klaim!";
            document.getElementById("status").className = "success";
            document.getElementById("ethAmount").innerHTML = `Jumlah ETH: ${winnings}`;
            document.getElementById("claimBtn").disabled = false;
        } else {
            document.getElementById("status").innerHTML = "‚ùå Maaf, Anda tidak bisa klaim.";
            document.getElementById("status").className = "error";
            document.getElementById("ethAmount").innerHTML = "Jumlah ETH: 0";
            document.getElementById("claimBtn").disabled = true;
        }
    } catch (error) {
        console.error("Error checking eligibility:", error);
    }
}

// üí∞ Klaim ETH
async function claimETH() {
    if (!contract || !userAccount) {
        alert("Harap sambungkan wallet terlebih dahulu.");
        return;
    }

    try {
        await contract.methods.claimETH().send({ from: userAccount });
        alert("Klaim berhasil! ETH telah dikirim ke dompet Anda.");
        checkEligibility();
        getWinners(); // Perbarui daftar pemenang
    } catch (error) {
        alert("Gagal klaim. Coba lagi.");
        console.error(error);
    }
}

// üèÜ Ambil Riwayat Pemenang
async function getWinners() {
    if (!contract) {
        alert("Harap sambungkan wallet terlebih dahulu.");
        return;
    }

    try {
        const allWinners = [];
        const events = await contract.getPastEvents("WinnerSet", { fromBlock: 0, toBlock: "latest" });

        events.forEach(event => {
            let betId = event.returnValues.betId;
            let winner = event.returnValues.winner;
            let amountBet = web3.utils.fromWei(event.returnValues.amountBet, "ether");
            let amountWon = web3.utils.fromWei(event.returnValues.amountWon, "ether");
            let timestamp = parseInt(event.returnValues.timestamp) * 1000;
            let dateUTC = new Date(timestamp).toISOString().replace("T", " ").replace("Z", "");

            allWinners.push({ betId, winner, amountBet, amountWon, dateUTC });
        });

        let winnersList = document.getElementById("winnersList");
        winnersList.innerHTML = "";

        allWinners.forEach(winner => {
            let row = `<tr>
                <td>${winner.betId}</td>
                <td>${winner.winner}</td>
                <td>${winner.amountBet} ETH</td>
                <td>${winner.amountWon} ETH</td>
                <td>${winner.dateUTC}</td>
            </tr>`;
            winnersList.innerHTML += row;
        });
    } catch (error) {
        console.error("Error fetching winners:", error);
    }
}

window.onload = async () => {
    if (window.ethereum) {
        web3 = new Web3(window.ethereum);
        const accounts = await web3.eth.getAccounts();
        if (accounts.length > 0) {
            userAccount = accounts[0];
            document.getElementById("walletAddress").innerText = `Wallet: ${userAccount}`;
            document.getElementById("connectWallet").disabled = true;
            document.getElementById("disconnectWallet").disabled = false;
            contract = new web3.eth.Contract(contractABI, contractAddress);
        }
    }
};
    </script>
</body>
</html>
