<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LottoChain Decentralized HK Pool</title>
    <link rel="stylesheet" href="styles.css">
    <script src="https://cdn.jsdelivr.net/npm/web3/dist/web3.min.js"></script>
    <style>
        body {
    font-family: Arial, sans-serif;
    background-color: #f4f4f4;
    text-align: center;
    margin: 0;
    padding: 20px;
}

.container {
    background: white;
    padding: 20px;
    border-radius: 10px;
    max-width: 400px;
    margin: auto;
    box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
}

button {
    background: #007bff;
    color: white;
    border: none;
    padding: 10px;
    cursor: pointer;
    margin: 10px 0;
    border-radius: 5px;
}

button:hover {
    background: #0056b3;
}

input {
    padding: 10px;
    width: 80%;
    margin: 10px 0;
}
    </style>
</head>
<body>
    <div class="container">
        <h1>LottoChain Decentralized HK Pool</h1>
        
        <button id="connectWallet">ðŸ”— Connect Wallet</button>
        <p id="walletAddress">Not connected</p>

        <h2>Place a Bet</h2>
        <input type="number" id="betNumber" placeholder="Number (0-9999)">
        <input type="number" id="betAmount" placeholder="Times (1-99)">
        <button id="placeBet">Place Bet</button>

        <h2>Claim Winnings</h2>
        <button id="claimETH">Claim ETH</button>
        <p id="ethBalance">ETH Balance: -</p>

        <h2>Lottery Results</h2>
        <p id="lotteryResult">Draw Result: -</p>

          <h2>Riwayat Taruhan</h2>
    <ul id="bet-history"></ul>

        <h2>Comments</h2>
        <input type="text" id="commentText" placeholder="Write a comment">
        <button id="addComment">Add Comment</button>
        <ul id="commentList"></ul>
    </div>

    <script src="script.js"></script>
    <script>
        let web3;
let contract;
let account;

const contractAddress = "0x49aAB5493F8a59091f50D23Ef24B6B55f067f9eC"; // Ganti dengan alamat kontrak di Base Sepolia
const contractABI = [{"inputs":[],"stateMutability":"nonpayable","type":"constructor"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"player","type":"address"},{"indexed":false,"internalType":"uint256","name":"number","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"betAmount","type":"uint256"},{"indexed":false,"internalType":"bool","name":"isETH","type":"bool"}],"name":"BetPlaced","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"drawId","type":"uint256"},{"indexed":false,"internalType":"address","name":"user","type":"address"},{"indexed":false,"internalType":"string","name":"text","type":"string"}],"name":"CommentAdded","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"drawId","type":"uint256"},{"indexed":false,"internalType":"address","name":"user","type":"address"},{"indexed":false,"internalType":"uint256","name":"commentIndex","type":"uint256"}],"name":"CommentDeleted","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"drawId","type":"uint256"},{"indexed":false,"internalType":"address","name":"user","type":"address"},{"indexed":false,"internalType":"uint256","name":"commentIndex","type":"uint256"},{"indexed":false,"internalType":"string","name":"newText","type":"string"}],"name":"CommentEdited","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"owner","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"}],"name":"ETHWithdrawn","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"drawId","type":"uint256"},{"indexed":false,"internalType":"address","name":"user","type":"address"},{"indexed":false,"internalType":"uint256","name":"commentIndex","type":"uint256"}],"name":"LikeAdded","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"drawId","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"number","type":"uint256"}],"name":"LotteryResult","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"sender","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"}],"name":"ReceivedETH","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"winner","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"}],"name":"WinnerSetETH","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"sender","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"}],"name":"WithdrawETH","type":"event"},{"inputs":[{"internalType":"uint256","name":"_drawId","type":"uint256"},{"internalType":"string","name":"_text","type":"string"}],"name":"addComment","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"},{"internalType":"uint256","name":"","type":"uint256"}],"name":"bets","outputs":[{"internalType":"address","name":"player","type":"address"},{"internalType":"uint256","name":"number","type":"uint256"},{"internalType":"uint256","name":"betAmount","type":"uint256"},{"internalType":"bool","name":"isETH","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"claimETH","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"},{"internalType":"uint256","name":"","type":"uint256"}],"name":"comments","outputs":[{"internalType":"address","name":"user","type":"address"},{"internalType":"string","name":"text","type":"string"},{"internalType":"uint256","name":"likes","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"contractETHBalance","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"_drawId","type":"uint256"},{"internalType":"uint256","name":"_commentIndex","type":"uint256"}],"name":"deleteComment","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"_drawId","type":"uint256"},{"internalType":"uint256","name":"_commentIndex","type":"uint256"},{"internalType":"string","name":"_newText","type":"string"}],"name":"editComment","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"ethBetPrice","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"ethWinnings","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"_amount","type":"uint256"}],"name":"executeWithdrawETH","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"_drawId","type":"uint256"},{"internalType":"uint256","name":"_commentIndex","type":"uint256"}],"name":"likeComment","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"maxBet","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"minBet","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"owner","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"_number","type":"uint256"},{"internalType":"uint256","name":"_times","type":"uint256"},{"internalType":"bool","name":"_isETH","type":"bool"}],"name":"placeBet","outputs":[],"stateMutability":"payable","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"results","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"_drawId","type":"uint256"},{"internalType":"uint256","name":"_number","type":"uint256"}],"name":"setLotteryResult","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"_winner","type":"address"},{"internalType":"uint256","name":"_amount","type":"uint256"}],"name":"setWinnerETH","outputs":[],"stateMutability":"nonpayable","type":"function"},{"stateMutability":"payable","type":"receive"}];
const BASE_SEPOLIA_CHAIN_ID = "0x14a34"; // Base Sepolia Testnet Chain ID

document.getElementById("connectWallet").addEventListener("click", connectWallet);
document.getElementById("placeBet").addEventListener("click", placeBet);
document.getElementById("claimETH").addEventListener("click", claimETH);
document.getElementById("addComment").addEventListener("click", addComment);

async function connectWallet() {
    if (!window.ethereum) {
        alert("Please install Metamask!");
        return;
    }

    web3 = new Web3(window.ethereum);

    try {
        const accounts = await ethereum.request({ method: "eth_requestAccounts" });
        account = accounts[0];
        document.getElementById("walletAddress").innerText = `Connected: ${account}`;

        await switchToBaseSepolia();

        contract = new web3.eth.Contract(contractABI, contractAddress);
        fetchLotteryResult();
    } catch (error) {
        console.error("Wallet connection failed", error);
    }
}

async function switchToBaseSepolia() {
    try {
        await ethereum.request({
            method: "wallet_switchEthereumChain",
            params: [{ chainId: BASE_SEPOLIA_CHAIN_ID }],
        });
    } catch (error) {
        console.error("Failed to switch to Base Sepolia Testnet", error);
    }
}

async function placeBet() {
    if (!account) {
        alert("Connect your wallet first!");
        return;
    }

    const number = document.getElementById("betNumber").value;
    const times = document.getElementById("betAmount").value;
    const betPrice = web3.utils.toWei("0.000175", "ether");
    const totalCost = web3.utils.toWei((times * 0.000175).toString(), "ether");

    try {
        await contract.methods.placeBet(number, times, true).send({
            from: account,
            value: totalCost
        });

        alert("Bet placed successfully!");
    } catch (error) {
        console.error("Bet placement failed", error);
        alert("Failed to place bet.");
    }
}

async function claimETH() {
    if (!account) {
        alert("Connect your wallet first!");
        return;
    }

    try {
        await contract.methods.claimETH().send({ from: account });
        alert("ETH claimed successfully!");
    } catch (error) {
        console.error("ETH claim failed", error);
        alert("Failed to claim ETH.");
    }
}

async function fetchLotteryResult() {
    try {
        const latestDrawId = 1;  // Ganti dengan ID hasil undian terbaru
        const result = await contract.methods.results(latestDrawId).call();
        document.getElementById("lotteryResult").innerText = `Draw Result: ${result}`;
    } catch (error) {
        console.error("Failed to fetch lottery result", error);
    }
}
        
async function addComment() {
    if (!account) {
        alert("Connect your wallet first!");
        return;
    }

    const text = document.getElementById("commentText").value;
    if (!text) {
        alert("Please enter a comment.");
        return;
    }

    try {
        const drawId = 1; // Sesuaikan dengan ID pengundian
        await contract.methods.addComment(drawId, text).send({ from: account });

        alert("Comment added successfully!");
        fetchComments(drawId);
    } catch (error) {
        console.error("Failed to add comment", error);
        alert("Failed to add comment.");
    }
}

async function fetchComments(drawId) {
    try {
        const comments = await contract.methods.comments(drawId).call();
        const commentList = document.getElementById("commentList");
        commentList.innerHTML = "";

        comments.forEach((comment, index) => {
            const li = document.createElement("li");
            li.innerText = `${comment.user}: ${comment.text} (Likes: ${comment.likes})`;

            const likeButton = document.createElement("button");
            likeButton.innerText = "ðŸ‘ Like";
            likeButton.onclick = () => likeComment(drawId, index);

            li.appendChild(likeButton);
            commentList.appendChild(li);
        });
    } catch (error) {
        console.error("Failed to fetch comments", error);
    }
}

async function likeComment(drawId, commentIndex) {
    if (!account) {
        alert("Connect your wallet first!");
        return;
    }

    try {
        await contract.methods.likeComment(drawId, commentIndex).send({ from: account });
        fetchComments(drawId);
    } catch (error) {
        console.error("Failed to like comment", error);
        alert("Failed to like comment.");
    }
    }
    </script>
    <script>
        const web3 = new Web3("https://sepolia.base.org");
        const web3 = new Web3("https://base-sepolia-rpc.publicnode.com"); 
        const contractAddress = "0x49aAB5493F8a59091f50D23Ef24B6B55f067f9eC"; // Ganti dengan alamat kontrakmu
        const contractABI = [{"inputs":[],"stateMutability":"nonpayable","type":"constructor"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"player","type":"address"},{"indexed":false,"internalType":"uint256","name":"number","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"betAmount","type":"uint256"},{"indexed":false,"internalType":"bool","name":"isETH","type":"bool"}],"name":"BetPlaced","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"drawId","type":"uint256"},{"indexed":false,"internalType":"address","name":"user","type":"address"},{"indexed":false,"internalType":"string","name":"text","type":"string"}],"name":"CommentAdded","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"drawId","type":"uint256"},{"indexed":false,"internalType":"address","name":"user","type":"address"},{"indexed":false,"internalType":"uint256","name":"commentIndex","type":"uint256"}],"name":"CommentDeleted","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"drawId","type":"uint256"},{"indexed":false,"internalType":"address","name":"user","type":"address"},{"indexed":false,"internalType":"uint256","name":"commentIndex","type":"uint256"},{"indexed":false,"internalType":"string","name":"newText","type":"string"}],"name":"CommentEdited","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"owner","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"}],"name":"ETHWithdrawn","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"drawId","type":"uint256"},{"indexed":false,"internalType":"address","name":"user","type":"address"},{"indexed":false,"internalType":"uint256","name":"commentIndex","type":"uint256"}],"name":"LikeAdded","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"drawId","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"number","type":"uint256"}],"name":"LotteryResult","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"sender","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"}],"name":"ReceivedETH","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"winner","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"}],"name":"WinnerSetETH","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"sender","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"}],"name":"WithdrawETH","type":"event"},{"inputs":[{"internalType":"uint256","name":"_drawId","type":"uint256"},{"internalType":"string","name":"_text","type":"string"}],"name":"addComment","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"},{"internalType":"uint256","name":"","type":"uint256"}],"name":"bets","outputs":[{"internalType":"address","name":"player","type":"address"},{"internalType":"uint256","name":"number","type":"uint256"},{"internalType":"uint256","name":"betAmount","type":"uint256"},{"internalType":"bool","name":"isETH","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"claimETH","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"},{"internalType":"uint256","name":"","type":"uint256"}],"name":"comments","outputs":[{"internalType":"address","name":"user","type":"address"},{"internalType":"string","name":"text","type":"string"},{"internalType":"uint256","name":"likes","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"contractETHBalance","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"_drawId","type":"uint256"},{"internalType":"uint256","name":"_commentIndex","type":"uint256"}],"name":"deleteComment","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"_drawId","type":"uint256"},{"internalType":"uint256","name":"_commentIndex","type":"uint256"},{"internalType":"string","name":"_newText","type":"string"}],"name":"editComment","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"ethBetPrice","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"ethWinnings","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"_amount","type":"uint256"}],"name":"executeWithdrawETH","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"_drawId","type":"uint256"},{"internalType":"uint256","name":"_commentIndex","type":"uint256"}],"name":"likeComment","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"maxBet","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"minBet","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"owner","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"_number","type":"uint256"},{"internalType":"uint256","name":"_times","type":"uint256"},{"internalType":"bool","name":"_isETH","type":"bool"}],"name":"placeBet","outputs":[],"stateMutability":"payable","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"results","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"_drawId","type":"uint256"},{"internalType":"uint256","name":"_number","type":"uint256"}],"name":"setLotteryResult","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"_winner","type":"address"},{"internalType":"uint256","name":"_amount","type":"uint256"}],"name":"setWinnerETH","outputs":[],"stateMutability":"nonpayable","type":"function"},{"stateMutability":"payable","type":"receive"}]; // Masukkan ABI kontrakmu di sini

        const contract = new web3.eth.Contract(contractABI, contractAddress);

console.log("Mendengarkan event BetPlaced...");

// Gunakan `getPastEvents` untuk menampilkan riwayat taruhan saat pertama kali membuka web
contract.getPastEvents("BetPlaced", { fromBlock: "earliest" })
.then(events => {
    events.forEach(event => updateBetHistory(event.returnValues));
})
.catch(console.error);

// Mendengarkan event terbaru
contract.events.BetPlaced()
.on("data", (event) => {
    console.log("Taruhan baru masuk:", event.returnValues);
    updateBetHistory(event.returnValues);
})
.on("error", console.error);

// Fungsi untuk menampilkan bet di HTML
function updateBetHistory(bet) {
    const betList = document.getElementById("bet-history");
    const newBet = document.createElement("li");
    newBet.innerText = `Player: ${bet.player}, Number: ${bet.number}, Bet: ${bet.betAmount}, ETH: ${bet.isETH}`;
    betList.appendChild(newBet);
}
    </script>
</body>
</html>
