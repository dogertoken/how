<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crypto Betting</title>
    <script src="https://cdn.jsdelivr.net/npm/web3@latest/dist/web3.min.js"></script>
</head>
<body>

    <h2>Crypto Betting Platform</h2>

    
<!-- HTML Wallet Connector -->
<button id="walletButton" onclick="toggleWallet()">üîó Connect Wallet</button>
<p id="walletAddress">Not connected</p>
<p id="ethBalance">ETH Balance: -</p>
<p id="usdtBalance">USDT Balance: -</p>
<p id="signature">Signature: -</p>

    <script>
    let web3;
    let account;
    const contractAddress = "0xYourContractAddress"; // Ganti dengan alamat smart contract
    const contractABI = [ /* Copy ABI Smart Contract di sini */ ];
    const usdtAddress = "0xYourUSDTContract"; // Ganti dengan alamat token USDT
    const usdtABI = [ /* ABI ERC-20 */ ];
    const BASE_SEPOLIA_CHAIN_ID = "0x14A34"; // Chain ID Base Sepolia dalam format hex

    async function switchToBaseSepolia() {
        if (!window.ethereum) {
            alert("Metamask is required!");
            return false;
        }

        try {
            const currentChainId = await window.ethereum.request({ method: "eth_chainId" });
            if (currentChainId === BASE_SEPOLIA_CHAIN_ID) {
                console.log("Already on Base Sepolia!");
                return true;
            }

            await window.ethereum.request({
                method: "wallet_switchEthereumChain",
                params: [{ chainId: BASE_SEPOLIA_CHAIN_ID }],
            });

            console.log("Switched to Base Sepolia!");
            return true;
        } catch (error) {
            if (error.code === 4902) {
                try {
                    await window.ethereum.request({
                        method: "wallet_addEthereumChain",
                        params: [{
                            chainId: BASE_SEPOLIA_CHAIN_ID,
                            chainName: "Base Sepolia",
                            rpcUrls: ["https://sepolia.base.org"],
                            nativeCurrency: {
                                name: "ETH",
                                symbol: "ETH",
                                decimals: 18
                            },
                            blockExplorerUrls: ["https://sepolia.basescan.org"]
                        }]
                    });

                    console.log("Base Sepolia added and switched!");
                    return true;
                } catch (addError) {
                    console.error("Failed to add Base Sepolia network", addError);
                    alert("Failed to add Base Sepolia. Please add it manually in Metamask.");
                    return false;
                }
            } else {
                console.error("Failed to switch network", error);
                alert("Please switch to Base Sepolia Testnet manually.");
                return false;
            }
        }
    }

    async function toggleWallet() {
        if (account) {
            account = null;
            document.getElementById("walletAddress").innerText = "Not connected";
            document.getElementById("walletButton").innerText = "üîó Connect Wallet";
            document.getElementById("ethBalance").innerText = "ETH Balance: -";
            document.getElementById("usdtBalance").innerText = "USDT Balance: -";
            document.getElementById("signature").innerText = "Signature: -";
        } else {
            if (window.ethereum) {
                web3 = new Web3(window.ethereum);
                try {
                    const switched = await switchToBaseSepolia();
                    if (!switched) return; 

                    const accounts = await ethereum.request({ method: "eth_requestAccounts" });
                    account = accounts[0];
                    document.getElementById("walletAddress").innerText = `Connected: ${account}`;
                    document.getElementById("walletButton").innerText = "‚ùå Disconnect";

                    await signMessage();
                    await fetchBalances();
                    fetchBetHistory();
                } catch (error) {
                    console.error("Wallet connection failed", error);
                }
            } else {
                alert("Please install Metamask!");
            }
        }
    }

    async function signMessage() {
        if (!account) {
            alert("Connect your wallet first!");
            return;
        }

        try {
            const message = `Sign in to Crypto Betting\n\nWallet: ${account}\nTimestamp: ${Date.now()}`;
            const signature = await ethereum.request({
                method: "personal_sign",
                params: [message, account],
            });

            const shortSignature = signature.slice(0, 10) + "..." + signature.slice(-10);
            const signatureElement = document.getElementById("signature");
            signatureElement.innerText = `Signature: ${shortSignature}`;
            signatureElement.setAttribute("title", `Full Signature: ${signature}`);

            console.log("Full Signature:", signature);
        } catch (error) {
            console.error("Failed to sign message", error);
            alert("Signing failed!");
        }
    }

    async function fetchBalances() {
        if (!account) return;

        const balanceWei = await web3.eth.getBalance(account);
        const balanceEth = web3.utils.fromWei(balanceWei, "ether");
        document.getElementById("ethBalance").innerText = `ETH Balance: ${balanceEth} ETH`;

        const usdtContract = new web3.eth.Contract(usdtABI, usdtAddress);
        const balanceUSDT = await usdtContract.methods.balanceOf(account).call();
        document.getElementById("usdtBalance").innerText = `USDT Balance: ${web3.utils.fromWei(balanceUSDT, "mwei")} USDT`;
    }

    </script>

</body>
</html>
