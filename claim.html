<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Claim ETH & Riwayat Pemenang</title>
    <script src="https://cdn.jsdelivr.net/npm/web3@latest/dist/web3.min.js"></script>
    <link rel="stylesheet" href="style.css">
    <style>
        /* ======= Style Umum ======= */
body {
    font-family: 'Arial', sans-serif;
    background-color: #121212;
    color: #ffffff;
    text-align: center;
    padding: 20px;
}

h2 {
    color: #00ffc3;
    margin-bottom: 15px;
}

/* ======= Tombol ======= */
button {
    background: linear-gradient(45deg, #00ff99, #0099ff);
    border: none;
    padding: 10px 20px;
    font-size: 16px;
    font-weight: bold;
    color: white;
    cursor: pointer;
    border-radius: 8px;
    transition: 0.3s;
}

button:hover {
    background: linear-gradient(45deg, #0099ff, #00ff99);
    transform: scale(1.05);
}

button:disabled {
    background: #555;
    cursor: not-allowed;
}

/* ======= Status ======= */
.success {
    color: #00ff99;
    font-weight: bold;
}

.error {
    color: #ff4444;
    font-weight: bold;
}

/* ======= Tabel Riwayat Pemenang ======= */
table {
    width: 90%;
    max-width: 800px;
    margin: 20px auto;
    border-collapse: collapse;
    background: #1e1e1e;
    border-radius: 10px;
    overflow: hidden;
}

th, td {
    padding: 12px;
    border-bottom: 1px solid #333;
}

th {
    background: #00ffc3;
    color: #121212;
}

tr:nth-child(even) {
    background: #282828;
}

tr:hover {
    background: #333;
    transition: 0.3s;
}
    </style>
</head>
<body>
    <h2>Claim ETH</h2>
    <button id="checkEligible" onclick="checkEligibility()">Check Eligible</button>
    <p id="status"></p>
    <p id="ethAmount"></p>
    <button id="claimBtn" onclick="claimETH()" disabled>Claim ETH</button>

    <h2>üèÜ Riwayat Pemenang</h2>
    <button id="refreshWinners" onclick="getWinners()">Refresh Riwayat</button>
    <table>
        <thead>
            <tr>
                <th>No. Bet</th>
                <th>Alamat</th>
                <th>Jumlah Bet</th>
                <th>Jumlah ETH</th>
                <th>Waktu (UTC)</th>
            </tr>
        </thead>
        <tbody id="winnersList"></tbody>
    </table>

    <script>
        const contractAddress = "0x410F02E143Ba921FEdda48830d545154F5E809ab"; // Ganti dengan alamat kontrak
        const contractABI = [{"inputs":[],"stateMutability":"nonpayable","type":"constructor"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"bytes32","name":"betId","type":"bytes32"},{"indexed":true,"internalType":"address","name":"user","type":"address"}],"name":"BetLiked","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"player","type":"address"},{"indexed":false,"internalType":"bytes32","name":"betId","type":"bytes32"},{"indexed":false,"internalType":"string","name":"number","type":"string"},{"indexed":false,"internalType":"uint256","name":"betAmount","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"timestamp","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"blockNumber","type":"uint256"},{"indexed":false,"internalType":"bytes32","name":"txHash","type":"bytes32"}],"name":"BetPlaced","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"uint256","name":"drawId","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"winningNumber","type":"uint256"}],"name":"BetResultSet","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"bytes32","name":"betId","type":"bytes32"},{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":false,"internalType":"string","name":"comment","type":"string"},{"indexed":false,"internalType":"uint256","name":"timestamp","type":"uint256"}],"name":"CommentAdded","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"bytes32","name":"betId","type":"bytes32"},{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":false,"internalType":"uint256","name":"commentIndex","type":"uint256"}],"name":"CommentDeleted","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"bytes32","name":"betId","type":"bytes32"},{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":false,"internalType":"uint256","name":"commentIndex","type":"uint256"},{"indexed":false,"internalType":"string","name":"newComment","type":"string"}],"name":"CommentUpdated","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"winner","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"}],"name":"ETHClaimed","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"winner","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"}],"name":"WinnerSet","type":"event"},{"inputs":[{"internalType":"bytes32","name":"betId","type":"bytes32"},{"internalType":"string","name":"_comment","type":"string"}],"name":"addComment","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"bytes32","name":"","type":"bytes32"},{"internalType":"uint256","name":"","type":"uint256"}],"name":"betComments","outputs":[{"internalType":"address","name":"commenter","type":"address"},{"internalType":"string","name":"text","type":"string"},{"internalType":"uint256","name":"timestamp","type":"uint256"},{"internalType":"bool","name":"isDeleted","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"betHistory","outputs":[{"internalType":"address","name":"player","type":"address"},{"internalType":"string","name":"number","type":"string"},{"internalType":"uint256","name":"betAmount","type":"uint256"},{"internalType":"uint256","name":"timestamp","type":"uint256"},{"internalType":"uint256","name":"blockNumber","type":"uint256"},{"internalType":"bytes32","name":"txHash","type":"bytes32"},{"internalType":"bool","name":"isETH","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"bytes32","name":"","type":"bytes32"},{"internalType":"address","name":"","type":"address"}],"name":"betLikes","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"betPrice","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"betResults","outputs":[{"internalType":"uint256","name":"drawId","type":"uint256"},{"internalType":"uint256","name":"winningNumber","type":"uint256"},{"internalType":"bool","name":"isProcessed","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"claimETH","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"contractBalance","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"bytes32","name":"betId","type":"bytes32"},{"internalType":"uint256","name":"commentIndex","type":"uint256"}],"name":"deleteComment","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"bytes32","name":"betId","type":"bytes32"},{"internalType":"uint256","name":"commentIndex","type":"uint256"},{"internalType":"string","name":"newComment","type":"string"}],"name":"editComment","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"getAllBets","outputs":[{"components":[{"internalType":"address","name":"player","type":"address"},{"internalType":"string","name":"number","type":"string"},{"internalType":"uint256","name":"betAmount","type":"uint256"},{"internalType":"uint256","name":"timestamp","type":"uint256"},{"internalType":"uint256","name":"blockNumber","type":"uint256"},{"internalType":"bytes32","name":"txHash","type":"bytes32"},{"internalType":"bool","name":"isETH","type":"bool"}],"internalType":"struct BetHistory.Bet[]","name":"","type":"tuple[]"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"bytes32","name":"betId","type":"bytes32"}],"name":"getComments","outputs":[{"components":[{"internalType":"address","name":"commenter","type":"address"},{"internalType":"string","name":"text","type":"string"},{"internalType":"uint256","name":"timestamp","type":"uint256"},{"internalType":"bool","name":"isDeleted","type":"bool"}],"internalType":"struct BetHistory.Comment[]","name":"","type":"tuple[]"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"_user","type":"address"}],"name":"getUserBets","outputs":[{"components":[{"internalType":"address","name":"player","type":"address"},{"internalType":"string","name":"number","type":"string"},{"internalType":"uint256","name":"betAmount","type":"uint256"},{"internalType":"uint256","name":"timestamp","type":"uint256"},{"internalType":"uint256","name":"blockNumber","type":"uint256"},{"internalType":"bytes32","name":"txHash","type":"bytes32"},{"internalType":"bool","name":"isETH","type":"bool"}],"internalType":"struct BetHistory.Bet[]","name":"","type":"tuple[]"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"bytes32","name":"betId","type":"bytes32"}],"name":"likeBet","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"maxBet","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"minBet","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"owner","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"string","name":"_number","type":"string"},{"internalType":"uint256","name":"_times","type":"uint256"},{"internalType":"bool","name":"_isETH","type":"bool"}],"name":"placeBet","outputs":[],"stateMutability":"payable","type":"function"},{"inputs":[{"internalType":"uint256","name":"_drawId","type":"uint256"},{"internalType":"uint256","name":"_winningNumber","type":"uint256"}],"name":"setBetResult","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"_winner","type":"address"},{"internalType":"uint256","name":"_amount","type":"uint256"}],"name":"setWinner","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"},{"internalType":"uint256","name":"","type":"uint256"}],"name":"userBets","outputs":[{"internalType":"address","name":"player","type":"address"},{"internalType":"string","name":"number","type":"string"},{"internalType":"uint256","name":"betAmount","type":"uint256"},{"internalType":"uint256","name":"timestamp","type":"uint256"},{"internalType":"uint256","name":"blockNumber","type":"uint256"},{"internalType":"bytes32","name":"txHash","type":"bytes32"},{"internalType":"bool","name":"isETH","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"winnings","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"_amount","type":"uint256"}],"name":"withdrawETH","outputs":[],"stateMutability":"nonpayable","type":"function"},{"stateMutability":"payable","type":"receive"}];
        
        let web3;
        let contract;
        let userAccount;

        async function initWeb3() {
            if (window.ethereum) {
                web3 = new Web3(window.ethereum);
                await window.ethereum.request({ method: "eth_requestAccounts" });
                const accounts = await web3.eth.getAccounts();
                userAccount = accounts[0];
                contract = new web3.eth.Contract(contractABI, contractAddress);
                getWinners(); // Auto-load winners
            } else {
                alert("Harap instal MetaMask!");
            }
        }

        async function checkEligibility() {
            if (!contract || !userAccount) {
                await initWeb3();
            }

            try {
                let winnings = await contract.methods.winnings(userAccount).call();
                winnings = web3.utils.fromWei(winnings, "ether");

                if (winnings > 0) {
                    document.getElementById("status").innerHTML = "‚úÖ Selamat, Anda bisa klaim!";
                    document.getElementById("status").className = "success";
                    document.getElementById("ethAmount").innerHTML = `Jumlah ETH: ${winnings}`;
                    document.getElementById("claimBtn").disabled = false;
                } else {
                    document.getElementById("status").innerHTML = "‚ùå Maaf, Anda tidak bisa klaim.";
                    document.getElementById("status").className = "error";
                    document.getElementById("ethAmount").innerHTML = "Jumlah ETH: 0";
                    document.getElementById("claimBtn").disabled = true;
                }
            } catch (error) {
                console.error("Error checking eligibility:", error);
            }
        }

        async function claimETH() {
            try {
                await contract.methods.claimETH().send({ from: userAccount });
                alert("Klaim berhasil! ETH telah dikirim ke dompet Anda.");
                checkEligibility();
                getWinners(); // Update list setelah klaim
            } catch (error) {
                alert("Gagal klaim. Coba lagi.");
                console.error(error);
            }
        }

        async function getWinners() {
            if (!contract) {
                await initWeb3();
            }

            try {
                const allWinners = [];
                const events = await contract.getPastEvents("WinnerSet", { fromBlock: 0, toBlock: "latest" });

                events.forEach(event => {
                    let betId = event.returnValues.betId; // Nomor taruhan
                    let winner = event.returnValues.winner;
                    let amountBet = web3.utils.fromWei(event.returnValues.amountBet, "ether"); // Jumlah taruhan
                    let amountWon = web3.utils.fromWei(event.returnValues.amountWon, "ether"); // Jumlah ETH menang
                    let timestamp = parseInt(event.returnValues.timestamp) * 1000; // Konversi ke ms
                    let dateUTC = new Date(timestamp).toISOString().replace("T", " ").replace("Z", ""); // Format UTC

                    allWinners.push({ betId, winner, amountBet, amountWon, dateUTC });
                });

                // Kosongkan tabel sebelum diisi ulang
                let winnersList = document.getElementById("winnersList");
                winnersList.innerHTML = "";

                allWinners.forEach(winner => {
                    let row = `<tr>
                        <td>${winner.betId}</td>
                        <td>${winner.winner}</td>
                        <td>${winner.amountBet} ETH</td>
                        <td>${winner.amountWon} ETH</td>
                        <td>${winner.dateUTC}</td>
                    </tr>`;
                    winnersList.innerHTML += row;
                });
            } catch (error) {
                console.error("Error fetching winners:", error);
            }
        }

        window.onload = initWeb3;
    </script>
</body>
</html>
