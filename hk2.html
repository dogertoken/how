<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bet History</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/web3/1.7.4/web3.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            padding: 20px;
        }
        .container {
            max-width: 600px;
            margin: auto;
        }
        button {
            padding: 10px;
            background: blue;
            color: white;
            border: none;
            cursor: pointer;
            margin: 5px;
        }
        input {
            width: 100%;
            padding: 8px;
            margin: 5px 0;
        }
        #betHistory, #userBets {
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <button id="connectWallet" onclick="connectWallet()">Connect Wallet</button>
        <button id="disconnectWallet" onclick="disconnectWallet()" style="display:none;">Disconnect Wallet</button>
        
        <h2>Place a Bet</h2>
        <input type="text" id="betNumber" placeholder="Enter 4D 3D 2D" oninput="limitBetNumber(this)">
        <p id="betNumberWarning" style="color: red;"></p>

         <input type="number" id="betTimes" placeholder="x1 / x99" min="1" max="99" oninput="limitDigits(this, 1, 99)">
         <p id="betTimesWarning" style="color: red;"></p>

        <button onclick="placeBet()">Place Bet</button>

        <h2>Public Bet History</h2>
        <div id="betHistory"></div>

        <h2>Your Bet History</h2>
        <div id="userBets"></div>
    </div>

    <script>
        const contractAddress = "0xBE0CAdD2E3f1bAD37f65E4Cc587f6b2d1FFBd687";
        const contractABI = [{"inputs":[],"stateMutability":"nonpayable","type":"constructor"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"bytes32","name":"betId","type":"bytes32"},{"indexed":true,"internalType":"address","name":"user","type":"address"}],"name":"BetLiked","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"player","type":"address"},{"indexed":false,"internalType":"bytes32","name":"betId","type":"bytes32"},{"indexed":false,"internalType":"uint256","name":"number","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"betAmount","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"timestamp","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"blockNumber","type":"uint256"},{"indexed":false,"internalType":"bytes32","name":"txHash","type":"bytes32"}],"name":"BetPlaced","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"uint256","name":"drawId","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"winningNumber","type":"uint256"}],"name":"BetResultSet","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"bytes32","name":"betId","type":"bytes32"},{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":false,"internalType":"string","name":"comment","type":"string"},{"indexed":false,"internalType":"uint256","name":"timestamp","type":"uint256"}],"name":"CommentAdded","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"bytes32","name":"betId","type":"bytes32"},{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":false,"internalType":"uint256","name":"commentIndex","type":"uint256"}],"name":"CommentDeleted","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"bytes32","name":"betId","type":"bytes32"},{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":false,"internalType":"uint256","name":"commentIndex","type":"uint256"},{"indexed":false,"internalType":"string","name":"newComment","type":"string"}],"name":"CommentUpdated","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"winner","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"}],"name":"ETHClaimed","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"winner","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"}],"name":"WinnerSet","type":"event"},{"inputs":[{"internalType":"bytes32","name":"betId","type":"bytes32"},{"internalType":"string","name":"_comment","type":"string"}],"name":"addComment","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"bytes32","name":"","type":"bytes32"},{"internalType":"uint256","name":"","type":"uint256"}],"name":"betComments","outputs":[{"internalType":"address","name":"commenter","type":"address"},{"internalType":"string","name":"text","type":"string"},{"internalType":"uint256","name":"timestamp","type":"uint256"},{"internalType":"bool","name":"isDeleted","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"betHistory","outputs":[{"internalType":"address","name":"player","type":"address"},{"internalType":"uint256","name":"number","type":"uint256"},{"internalType":"uint256","name":"betAmount","type":"uint256"},{"internalType":"uint256","name":"timestamp","type":"uint256"},{"internalType":"uint256","name":"blockNumber","type":"uint256"},{"internalType":"bytes32","name":"txHash","type":"bytes32"},{"internalType":"bool","name":"isETH","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"bytes32","name":"","type":"bytes32"},{"internalType":"address","name":"","type":"address"}],"name":"betLikes","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"betPrice","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"betResults","outputs":[{"internalType":"uint256","name":"drawId","type":"uint256"},{"internalType":"uint256","name":"winningNumber","type":"uint256"},{"internalType":"bool","name":"isProcessed","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"claimETH","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"contractBalance","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"bytes32","name":"betId","type":"bytes32"},{"internalType":"uint256","name":"commentIndex","type":"uint256"}],"name":"deleteComment","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"bytes32","name":"betId","type":"bytes32"},{"internalType":"uint256","name":"commentIndex","type":"uint256"},{"internalType":"string","name":"newComment","type":"string"}],"name":"editComment","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"getAllBets","outputs":[{"components":[{"internalType":"address","name":"player","type":"address"},{"internalType":"uint256","name":"number","type":"uint256"},{"internalType":"uint256","name":"betAmount","type":"uint256"},{"internalType":"uint256","name":"timestamp","type":"uint256"},{"internalType":"uint256","name":"blockNumber","type":"uint256"},{"internalType":"bytes32","name":"txHash","type":"bytes32"},{"internalType":"bool","name":"isETH","type":"bool"}],"internalType":"struct BetHistory.Bet[]","name":"","type":"tuple[]"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"bytes32","name":"betId","type":"bytes32"}],"name":"getComments","outputs":[{"components":[{"internalType":"address","name":"commenter","type":"address"},{"internalType":"string","name":"text","type":"string"},{"internalType":"uint256","name":"timestamp","type":"uint256"},{"internalType":"bool","name":"isDeleted","type":"bool"}],"internalType":"struct BetHistory.Comment[]","name":"","type":"tuple[]"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"_user","type":"address"}],"name":"getUserBets","outputs":[{"components":[{"internalType":"address","name":"player","type":"address"},{"internalType":"uint256","name":"number","type":"uint256"},{"internalType":"uint256","name":"betAmount","type":"uint256"},{"internalType":"uint256","name":"timestamp","type":"uint256"},{"internalType":"uint256","name":"blockNumber","type":"uint256"},{"internalType":"bytes32","name":"txHash","type":"bytes32"},{"internalType":"bool","name":"isETH","type":"bool"}],"internalType":"struct BetHistory.Bet[]","name":"","type":"tuple[]"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"bytes32","name":"betId","type":"bytes32"}],"name":"likeBet","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"maxBet","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"minBet","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"owner","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"_number","type":"uint256"},{"internalType":"uint256","name":"_times","type":"uint256"},{"internalType":"bool","name":"_isETH","type":"bool"}],"name":"placeBet","outputs":[],"stateMutability":"payable","type":"function"},{"inputs":[{"internalType":"uint256","name":"_drawId","type":"uint256"},{"internalType":"uint256","name":"_winningNumber","type":"uint256"}],"name":"setBetResult","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"_winner","type":"address"},{"internalType":"uint256","name":"_amount","type":"uint256"}],"name":"setWinner","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"},{"internalType":"uint256","name":"","type":"uint256"}],"name":"userBets","outputs":[{"internalType":"address","name":"player","type":"address"},{"internalType":"uint256","name":"number","type":"uint256"},{"internalType":"uint256","name":"betAmount","type":"uint256"},{"internalType":"uint256","name":"timestamp","type":"uint256"},{"internalType":"uint256","name":"blockNumber","type":"uint256"},{"internalType":"bytes32","name":"txHash","type":"bytes32"},{"internalType":"bool","name":"isETH","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"winnings","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"_amount","type":"uint256"}],"name":"withdrawETH","outputs":[],"stateMutability":"nonpayable","type":"function"},{"stateMutability":"payable","type":"receive"}];

        let web3;
        let contract;
        let userAccount;

        async function connectWallet() {
            if (window.ethereum) {
                web3 = new Web3(window.ethereum);
                const accounts = await window.ethereum.request({ method: "eth_requestAccounts" });
                userAccount = accounts[0];
                contract = new web3.eth.Contract(contractABI, contractAddress);
                document.getElementById("connectWallet").style.display = "none";
                document.getElementById("disconnectWallet").style.display = "inline-block";
                loadBetHistory();
                loadUserBets();
            } else {
                alert("Please install MetaMask to use this feature.");
            }
        }

        function disconnectWallet() {
            userAccount = null;
            document.getElementById("connectWallet").style.display = "inline-block";
            document.getElementById("disconnectWallet").style.display = "none";
            alert("Wallet disconnected");
        }

    async function placeBet() {
    if (!userAccount) {
        alert("Please connect your wallet first.");
        return;
    }

    if (!validateForm()) return; // Pastikan input valid sebelum lanjut

    const number = document.getElementById("betNumber").value;
    const times = parseInt(document.getElementById("betTimes").value, 10);
    
    if (isNaN(times) || times < 1) {
        alert("Invalid bet times value.");
        return;
    }

    const value = web3.utils.toWei((0.000175 * times).toString(), "ether");

    try {
        alert("Sending your bet..."); // Konfirmasi awal
        await contract.methods.placeBet(number, times, true).send({ from: userAccount, value: value });
        alert("Bet placed successfully!"); // Konfirmasi setelah berhasil

        loadBetHistory();
        loadUserBets();
    } catch (error) {
        alert("Bet failed: " + (error.message || "Unknown error")); // Tangani error dengan lebih baik
    }
}

function limitBetNumber(input) {
    let value = input.value.replace(/\D/g, ''); // Hanya angka, hapus karakter non-angka

    // Pastikan tetap ada leading zero jika diketik manual
    if (value.length > 4) {
        value = value.slice(0, 4); // Batasi maksimal 4 digit
    }

    // Validasi panjang angka minimal 2 digit
    if (value.length > 0 && value.length < 2) {
        document.getElementById("betNumberWarning").innerText = "Minimum 2 digits (00 - 9999)";
    } else {
        document.getElementById("betNumberWarning").innerText = "";
    }

    input.value = value; // Set kembali ke input tanpa menghapus nol di depan
}

function limitDigits(input, min, max) {
    let value = input.value.replace(/\D/g, '').trim();
    let numValue = parseInt(value, 10) || 0;

    if (!value) {
        document.getElementById("betTimesWarning").innerText = "Cannot be empty";
        input.value = ""; // Kosongkan input jika tidak valid
    } else if (numValue < min) {
        input.value = min; // Paksa minimal
        document.getElementById("betTimesWarning").innerText = `Enter numbers ${min} - ${max}`;
    } else if (numValue > max) {
        input.value = max; // Paksa maksimal
        document.getElementById("betTimesWarning").innerText = `Enter numbers ${min} - ${max}`;
    } else {
        document.getElementById("betTimesWarning").innerText = "";
        input.value = numValue;
    }
}

function validateForm() {
    let betNumber = document.getElementById("betNumber").value;
    let betTimes = parseInt(document.getElementById("betTimes").value, 10) || 0;
    let isValid = true;

    if (betNumber.length < 2 || betNumber.length > 4) {
        document.getElementById("betNumberWarning").innerText = "Minimum 2 digits, maximum 4 digits (00 - 9999)";
        isValid = false;
    } else {
        document.getElementById("betNumberWarning").innerText = "";
    }

    if (betTimes < 1 || betTimes > 99) {
        document.getElementById("betTimesWarning").innerText = "Enter number 1 - 99";
        isValid = false;
    } else {
        document.getElementById("betTimesWarning").innerText = "";
    }

    return isValid;
    }
        
        async function loadBetHistory() {
    const bets = await contract.methods.getAllBets().call();
    let betList = "";
    for (let i = bets.length - 1; i >= 0; i--) { // Membalik urutan iterasi
        const bet = bets[i];
        const timestamp = new Date(bet.timestamp * 1000).toISOString().replace("T", " ").replace("Z", " UTC");
        const blockLink = `https://sepolia.basescan.org/block/${bet.blockNumber}`; // Ganti sesuai blockchain yang digunakan
        const status = bet.txHash 
        ? '<span style="color: green;">Confirmed</span>' 
        : '<span style="color: red;">Pending</span>'; // Jika belum ada blockNumber, berarti masih pending
        const shortTx = bet.txHash ? `${bet.txHash.slice(0, 10)}...${bet.txHash.slice(-10)}` : "Pending";
        const shortPlayer = bet.player ? `${bet.player.slice(0, 10)}...${bet.player.slice(-10)}` : "Unknown";

        betList += `<p>
            Player: ${shortPlayer}<br> 
            BetNumber: <span style="color: orange;">${bet.number}</span><br> 
            BetAmount: <span style="color: orange;">${bet.betAmount}</span><br> 
            TX: ${shortTx}<br> 
            Block: <a href="${blockLink}" target="_blank">${bet.blockNumber}</a><br> 
            Status: ${status}<br> 
            Time: <span style="color: #8e44ad;">${timestamp}</span><br>
        </p><hr>`;
    }
    document.getElementById("betHistory").innerHTML = betList;
        }

        async function loadUserBets() {
    const accounts = await web3.eth.getAccounts();
    const bets = await contract.methods.getUserBets(accounts[0]).call();
    let betList = "";
    for (let i = bets.length - 1; i >= 0; i--) { // Membalik urutan iterasi
        const bet = bets[i];
        const timestamp = new Date(bet.timestamp * 1000).toISOString().replace("T", " ").replace("Z", " UTC");
        const blockLink = `https://sepolia.basescan.org/block/${bet.blockNumber}`; // Ganti sesuai blockchain yang digunakan
        const status = bet.txHash 
        ? '<span style="color: green;">Confirmed</span>' 
        : '<span style="color: red;">Pending</span>'; // Jika belum ada blockNumber, berarti masih pending
        const shortTx = bet.txHash ? `${bet.txHash.slice(0, 10)}...${bet.txHash.slice(-10)}` : "Pending";

        betList += `<p>
            BetNumber: <span style="color: orange;">${bet.number}</span><br> 
            BetAmount: <span style="color: orange;">${bet.betAmount}</span><br>
            TX: ${shortTx}<br> 
            Block: <a href="${blockLink}" target="_blank">${bet.blockNumber}</a><br>
            Status: ${status}<br>
            Time: <span style="color: #8e44ad;">${timestamp}</span><br>
        </p><hr>`;
    }
    document.getElementById("userBets").innerHTML = betList;
        }

        window.onload = init;
    </script>
</body>
</html>
