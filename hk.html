<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bet History DApp</title>
    <link rel="stylesheet" href="style.css">
    <link href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/web3/1.8.0/web3.min.js"></script>
    <style>
        body {
    font-family: Ubuntu, sans-serif;
    text-align: center;
    background-color: #f4f4f4;
}

.container {
    max-width: 600px;
    margin: auto;
    padding: 20px;
    background: white;
    box-shadow: 0px 0px 10px rgba(0, 0, 0, 0.1);
    border-radius: 5px;
}

input, button {
    display: block;
    margin: 10px auto;
    padding: 10px;
    width: 90%;
}

button {
    background-color: #28a745;
    color: white;
    border: none;
    cursor: pointer;
}

button:hover {
    background-color: #218838;
}

#disconnectWallet {
    background-color: #dc3545;
}

#disconnectWallet:hover {
    background-color: #c82333;
}
        
.nav-button {
    background-color: #28a745;
    color: white;
    border: none;
    cursor: pointer;
    width: 80px; /* Ukuran tombol lebih pendek */
    padding: 8px;
    display: inline-block;
    margin: 5px;
}

.button-container {
    display: flex;
    justify-content: center; /* Pusatkan tombol di tengah */
    gap: 10px; /* Jarak antar tombol */
}

#userBets {
    text-align: justify; /* Meratakan teks seperti di buku */
    hyphens: auto; /* Menambahkan pemenggalan kata jika perlu */
    line-height: 1.6; /* Jarak antar baris agar lebih nyaman dibaca */
    max-width: 600px; /* Batasi lebar agar tidak terlalu panjang */
    margin: auto; /* Pusatkan jika diperlukan */
}

#betHistory {
    text-align: justify; /* Meratakan teks seperti di buku */
    hyphens: auto; /* Menambahkan pemenggalan kata jika perlu */
    line-height: 1.6; /* Jarak antar baris agar lebih nyaman dibaca */
    max-width: 600px; /* Batasi lebar agar tidak terlalu panjang */
    margin: auto; /* Pusatkan jika diperlukan */
}
    </style>
</head>
<body>
    <div class="container">
        <h1>Lotto Bet DApp</h1>
        
        <!-- Wallet Connection -->
        <button id="connectWallet" onclick="connectWallet()">Connect Wallet</button>
        <button id="disconnectWallet" onclick="disconnectWallet()" style="display:none;">Disconnect</button>
        <p id="walletAddress"></p>

        <h2>Place Bet</h2>
        <input type="text" id="betNumber" placeholder="4D 3D or 2D" oninput="validateBetNumber()">
        <input type="number" id="betTimes" placeholder="x1 / x99" min="1" max="99" oninput="validateBetTimes(); updateBetPrice()">
        <p id="betWarning" style="color: red;"></p>
        <p id="betPrice" style="color: blue; font-weight: bold;">Price: 0.000000 ETH</p>
        <button onclick="placeBet()">Place Bet</button>
        <p id="betStatus"></p>
        <h2>Your Bets</h2>
        <div id="userBets"></div>
        <div class="button-container">
        <button class="nav-button" onclick="prevUserBets()">Prev</button>
        <button class="nav-button" onclick="nextUserBets()">Next</button>
      </div>

       <h2>Public Bet History</h2>
       <div id="betHistory"></div>
       <div class="button-container">
       <button class="nav-button" onclick="prevBetHistory()">Prev</button>
       <button class="nav-button" onclick="nextBetHistory()">Next</button>
    
    </div>

    <script src="script.js"></script>
    <script>
        const contractAddress = "0x410F02E143Ba921FEdda48830d545154F5E809ab";
        const contractABI = [{"inputs":[],"stateMutability":"nonpayable","type":"constructor"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"bytes32","name":"betId","type":"bytes32"},{"indexed":true,"internalType":"address","name":"user","type":"address"}],"name":"BetLiked","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"player","type":"address"},{"indexed":false,"internalType":"bytes32","name":"betId","type":"bytes32"},{"indexed":false,"internalType":"string","name":"number","type":"string"},{"indexed":false,"internalType":"uint256","name":"betAmount","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"timestamp","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"blockNumber","type":"uint256"},{"indexed":false,"internalType":"bytes32","name":"txHash","type":"bytes32"}],"name":"BetPlaced","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"uint256","name":"drawId","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"winningNumber","type":"uint256"}],"name":"BetResultSet","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"bytes32","name":"betId","type":"bytes32"},{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":false,"internalType":"string","name":"comment","type":"string"},{"indexed":false,"internalType":"uint256","name":"timestamp","type":"uint256"}],"name":"CommentAdded","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"bytes32","name":"betId","type":"bytes32"},{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":false,"internalType":"uint256","name":"commentIndex","type":"uint256"}],"name":"CommentDeleted","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"bytes32","name":"betId","type":"bytes32"},{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":false,"internalType":"uint256","name":"commentIndex","type":"uint256"},{"indexed":false,"internalType":"string","name":"newComment","type":"string"}],"name":"CommentUpdated","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"winner","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"}],"name":"ETHClaimed","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"winner","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"}],"name":"WinnerSet","type":"event"},{"inputs":[{"internalType":"bytes32","name":"betId","type":"bytes32"},{"internalType":"string","name":"_comment","type":"string"}],"name":"addComment","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"bytes32","name":"","type":"bytes32"},{"internalType":"uint256","name":"","type":"uint256"}],"name":"betComments","outputs":[{"internalType":"address","name":"commenter","type":"address"},{"internalType":"string","name":"text","type":"string"},{"internalType":"uint256","name":"timestamp","type":"uint256"},{"internalType":"bool","name":"isDeleted","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"betHistory","outputs":[{"internalType":"address","name":"player","type":"address"},{"internalType":"string","name":"number","type":"string"},{"internalType":"uint256","name":"betAmount","type":"uint256"},{"internalType":"uint256","name":"timestamp","type":"uint256"},{"internalType":"uint256","name":"blockNumber","type":"uint256"},{"internalType":"bytes32","name":"txHash","type":"bytes32"},{"internalType":"bool","name":"isETH","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"bytes32","name":"","type":"bytes32"},{"internalType":"address","name":"","type":"address"}],"name":"betLikes","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"betPrice","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"betResults","outputs":[{"internalType":"uint256","name":"drawId","type":"uint256"},{"internalType":"uint256","name":"winningNumber","type":"uint256"},{"internalType":"bool","name":"isProcessed","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"claimETH","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"contractBalance","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"bytes32","name":"betId","type":"bytes32"},{"internalType":"uint256","name":"commentIndex","type":"uint256"}],"name":"deleteComment","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"bytes32","name":"betId","type":"bytes32"},{"internalType":"uint256","name":"commentIndex","type":"uint256"},{"internalType":"string","name":"newComment","type":"string"}],"name":"editComment","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"getAllBets","outputs":[{"components":[{"internalType":"address","name":"player","type":"address"},{"internalType":"string","name":"number","type":"string"},{"internalType":"uint256","name":"betAmount","type":"uint256"},{"internalType":"uint256","name":"timestamp","type":"uint256"},{"internalType":"uint256","name":"blockNumber","type":"uint256"},{"internalType":"bytes32","name":"txHash","type":"bytes32"},{"internalType":"bool","name":"isETH","type":"bool"}],"internalType":"struct BetHistory.Bet[]","name":"","type":"tuple[]"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"bytes32","name":"betId","type":"bytes32"}],"name":"getComments","outputs":[{"components":[{"internalType":"address","name":"commenter","type":"address"},{"internalType":"string","name":"text","type":"string"},{"internalType":"uint256","name":"timestamp","type":"uint256"},{"internalType":"bool","name":"isDeleted","type":"bool"}],"internalType":"struct BetHistory.Comment[]","name":"","type":"tuple[]"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"_user","type":"address"}],"name":"getUserBets","outputs":[{"components":[{"internalType":"address","name":"player","type":"address"},{"internalType":"string","name":"number","type":"string"},{"internalType":"uint256","name":"betAmount","type":"uint256"},{"internalType":"uint256","name":"timestamp","type":"uint256"},{"internalType":"uint256","name":"blockNumber","type":"uint256"},{"internalType":"bytes32","name":"txHash","type":"bytes32"},{"internalType":"bool","name":"isETH","type":"bool"}],"internalType":"struct BetHistory.Bet[]","name":"","type":"tuple[]"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"bytes32","name":"betId","type":"bytes32"}],"name":"likeBet","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"maxBet","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"minBet","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"owner","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"string","name":"_number","type":"string"},{"internalType":"uint256","name":"_times","type":"uint256"},{"internalType":"bool","name":"_isETH","type":"bool"}],"name":"placeBet","outputs":[],"stateMutability":"payable","type":"function"},{"inputs":[{"internalType":"uint256","name":"_drawId","type":"uint256"},{"internalType":"uint256","name":"_winningNumber","type":"uint256"}],"name":"setBetResult","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"_winner","type":"address"},{"internalType":"uint256","name":"_amount","type":"uint256"}],"name":"setWinner","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"},{"internalType":"uint256","name":"","type":"uint256"}],"name":"userBets","outputs":[{"internalType":"address","name":"player","type":"address"},{"internalType":"string","name":"number","type":"string"},{"internalType":"uint256","name":"betAmount","type":"uint256"},{"internalType":"uint256","name":"timestamp","type":"uint256"},{"internalType":"uint256","name":"blockNumber","type":"uint256"},{"internalType":"bytes32","name":"txHash","type":"bytes32"},{"internalType":"bool","name":"isETH","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"winnings","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"_amount","type":"uint256"}],"name":"withdrawETH","outputs":[],"stateMutability":"nonpayable","type":"function"},{"stateMutability":"payable","type":"receive"}];
        const betPrice = 0.000175;

        let web3;
let contract;
let userAccount;
let userBetsPage = 0;
let betHistoryPage = 0;
const pageSize = 10;

// **Connect Wallet**
async function connectWallet() {
    if (window.ethereum) {
        try {
            web3 = new Web3(window.ethereum);
            await window.ethereum.request({ method: "eth_requestAccounts" });
            const accounts = await web3.eth.getAccounts();
            userAccount = accounts[0];
            contract = new web3.eth.Contract(contractABI, contractAddress);

            document.getElementById("walletAddress").innerText = `Connected: ${userAccount}`;
            document.getElementById("connectWallet").style.display = "none";
            document.getElementById("disconnectWallet").style.display = "block";

            loadUserBets();
            loadBetHistory();
        } catch (error) {
            console.error(error);
            alert("Connection failed!");
        }
    } else {
        alert("Please install MetaMask!");
    }
}

// **Disconnect Wallet**
function disconnectWallet() {
    userAccount = null;
    document.getElementById("walletAddress").innerText = "Disconnected";
    document.getElementById("connectWallet").style.display = "block";
    document.getElementById("disconnectWallet").style.display = "none";
}
       
function updateBetPrice() {
    let betTimes = document.getElementById("betTimes").value;
    let ethPrice = (betTimes * 0.000175).toFixed(6); // Hitung harga ETH
    document.getElementById("betPrice").innerText = `Price: ${ethPrice} ETH`;
}

// **Place Bet**
async function placeBet() {
    if (!userAccount) {
        alert("Please connect your wallet first!");
        return;
    }

    const number = document.getElementById("betNumber").value;
    const times = parseInt(document.getElementById("betTimes").value);
    const betPrice = web3.utils.toWei("0.000175", "ether");
    const totalCost = betPrice * times;

    if (!number || number.length < 1 || number.length > 4 || isNaN(times) || times < 1) {
        alert("Invalid bet input!");
        return;
    }
    
try {
        await contract.methods.placeBet(number, times, true).send({
            from: userAccount,
            value: totalCost
        });
        document.getElementById("betStatus").innerText = "Bet placed successfully!";
        loadUserBets();
    } catch (error) {
        console.error(error);
        document.getElementById("betStatus").innerText = "Transaction failed!";
    }
}

// Number Funcion
function validateBetNumber() {
    let betNumberInput = document.getElementById("betNumber");
    let betWarning = document.getElementById("betWarning");

    // Hanya angka yang diperbolehkan
    betNumberInput.value = betNumberInput.value.replace(/\D/g, "");

    if (betNumberInput.value.length < 2) {
        betWarning.innerText = "Bet number must minimum be 2 digits!";
    } else if (betNumberInput.value.length > 4) {
        betWarning.innerText = "Bet number must minimum 4 digits!";
        betNumberInput.value = betNumberInput.value.slice(0, 4); // Membatasi maksimal 4 digit
    } else {
        betWarning.innerText = "";
    }
}

function validateBetTimes() {
    let betTimesInput = document.getElementById("betTimes");
    let warning = document.getElementById("betWarning");

    let value = parseInt(betTimesInput.value, 10); // Konversi ke angka

    if (value < 1) {
        betTimesInput.value = 1;
        warning.innerText = "Bet times must be between 1 and 99!";
    } else if (value > 99) {
        betTimesInput.value = 99;
        warning.innerText = "Bet times must be between 1 and 99!";
    } else {
        warning.innerText = "";
    }
}

// Search betHistory Data
document.addEventListener("DOMContentLoaded", function () {
    // Buat elemen pencarian
    const searchContainer = document.createElement("div");
    searchContainer.style.marginBottom = "10px"; // Tambahkan margin agar lebih rapi
    searchContainer.innerHTML = `
        <input type="text" id="searchInput" placeholder="Search Player, Tx, Bet Number..." oninput="searchHistory()">
        <button id="searchButton" onclick="clearSearch()">‚ùå Clear</button>
    `;

    // Sisipkan pencarian sebelum betHistory
    const betHistoryDiv = document.getElementById("betHistory");
    betHistoryDiv.parentNode.insertBefore(searchContainer, betHistoryDiv);
});

// **Fungsi untuk Mencari Data dalam Riwayat**
function searchHistory() {
    const searchTerm = document.getElementById("searchInput").value.trim().toLowerCase();
    const betHistory = document.getElementById("betHistory");
    const items = betHistory.getElementsByTagName("p"); // Ambil semua elemen <p> dalam betHistory

    let found = false;

    for (let i = 0; i < items.length; i++) {
        const text = items[i].textContent.toLowerCase(); 

        if (text.includes(searchTerm)) { // Cek kecocokan dengan .includes()
            items[i].style.display = "";
            found = true;
        } else {
            items[i].style.display = "none";
        }
    }

    // Jika tidak ditemukan, tampilkan pesan
    if (!found) {
        betHistory.innerHTML = "<p style='color:red;'>No results found.</p>";
    }
}

// **Fungsi untuk Menghapus Pencarian**
function clearSearch() {
    document.getElementById("searchInput").value = "";
    const betHistory = document.getElementById("betHistory");
    const items = betHistory.getElementsByTagName("p");

    for (let i = 0; i < items.length; i++) {
        items[i].style.display = "";
    }
}

function clearSearch() {
    document.getElementById("searchInput").value = "";
    const betHistory = document.getElementById("betHistory");
    const items = betHistory.getElementsByTagName("p");

    for (let i = 0; i < items.length; i++) {
        items[i].style.display = "";
    }

    // Sembunyikan pesan "No results found"
    document.getElementById("noResults").style.display = "none";
}
    
// **Load User Bets (with Pagination)**
async function loadUserBets() {
    if (!userAccount) return;
    const bets = await contract.methods.getUserBets(userAccount).call();
    const reversedBets = bets.slice().reverse(); // Membalik urutan bets agar yang terbaru di atas

    const start = userBetsPage * pageSize;
    const end = Math.min(start + pageSize, reversedBets.length);

    let html = "";
    for (let i = start; i < end; i++) {
        let shortAddress = reversedBets[i].player.slice(0, 10) + "..." + reversedBets[i].player.slice(-10);
        let shortTxHash = reversedBets[i].txHash.slice(0, 10) + "..." + reversedBets[i].txHash.slice(-10);

        html += `<p>
            Address: <span style="color: purple;">${shortAddress}</span><br>
            BetNumber: <span style="color: green;">${reversedBets[i].number}</span><br>
            BetAmount: <span style="color: green;">${reversedBets[i].betAmount}</span><br>
            Tx: ${shortTxHash}<br>
            Block: <a href="https://basescan.io/block/${reversedBets[i].blockNumber}" target="_blank">${reversedBets[i].blockNumber}</a><br>
            Time: <span style="color: orange;">${new Date(reversedBets[i].timestamp * 1000).toISOString()} UTC</span><br>
        </p><hr>`;
    }
    document.getElementById("userBets").innerHTML = html;
}

// **User Bets Pagination**
function prevUserBets() {
    if (userBetsPage > 0) {
        userBetsPage--;
        loadUserBets();
    }
}

function nextUserBets() {
    userBetsPage++;
    loadUserBets();
}

// **Load Bet History (with Pagination)**
async function loadBetHistory() {
    const bets = await contract.methods.getAllBets().call();
    const reversedBets = bets.slice().reverse(); // Membalik urutan bets

    const start = betHistoryPage * pageSize;
    const end = Math.min(start + pageSize, reversedBets.length);

    let html = "";
    for (let i = start; i < end; i++) {
        let bet = reversedBets[i];
        let shortPlayer = bet.player.slice(0, 10) + "..." + bet.player.slice(-10);
        let shortTxHash = bet.txHash.slice(0, 10) + "..." + bet.txHash.slice(-10);

        html += `<p>
            Player: <span style="color: purple;">${shortPlayer}</span><br>
            BetNumber: <span style="color: green;">${bet.number}</span><br>
            BetAmount: <span style="color: green;">${bet.betAmount}</span><br>
            Tx: ${shortTxHash}<br>
            Block: <a href="https://basescan.io/block/${bet.blockNumber}" target="_blank">${bet.blockNumber}</a><br>
            Time: <span style="color: orange;">${new Date(bet.timestamp * 1000).toISOString()} UTC</span><br>
            <button onclick="likeBet('${bet.betId}')">üéØ Like</button>
            <span id="like-${bet.betId}">0</span> Likes
        </p><hr>`;
    }
    document.getElementById("betHistory").innerHTML = html;
}

// **Fungsi Like Bet via MetaMask**
async function likeBet(betId) {
    try {
        const accounts = await ethereum.request({ method: "eth_requestAccounts" });
        const sender = accounts[0];

        // Pastikan Bet ID dalam format 32-byte hex
        if (!web3.utils.isHexStrict(betId)) {
            betId = web3.utils.padLeft(web3.utils.toHex(betId), 64);
        }

        // Cek apakah user sudah like sebelumnya
        const alreadyLiked = await contract.methods.betLikes(betId, sender).call();
        if (alreadyLiked) {
            alert("Anda sudah menyukai bet ini.");
            return;
        }

        console.log("Sender:", sender);
        console.log("Bet ID:", betId);

        await contract.methods.likeBet(betId).send({ from: sender, gas: 300000 });

        let likeElement = document.getElementById(`like-${betId}`);
        likeElement.textContent = parseInt(likeElement.textContent) + 1;

        console.log("Like berhasil dikirim!");
    } catch (error) {
        console.error("Error saat menyukai bet:", error);
        alert(`Gagal menyukai bet. Error: ${error.message}`);
    }
}
        
// **Bet History Pagination**
function prevBetHistory() {
    if (betHistoryPage > 0) {
        betHistoryPage--;
        loadBetHistory();
    }
}

function nextBetHistory() {
    betHistoryPage++;
    loadBetHistory();
}

// Initialize saat halaman terbuka
window.onload = () => {
    if (window.ethereum) {
        window.ethereum.on("accountsChanged", (accounts) => {
            if (accounts.length > 0) {
                userAccount = accounts[0];
                document.getElementById("walletAddress").innerText = `Connected: ${userAccount}`;
                document.getElementById("connectWallet").style.display = "none";
                document.getElementById("disconnectWallet").style.display = "block";
                loadUserBets();
                loadBetHistory();
            } else {
                disconnectWallet();
            }
        });
    }
};
    </script>
</body>
</html>
