<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bet History DApp</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/web3/1.8.0/web3.min.js"></script>
    <style>
        body {
    font-family: Arial, sans-serif;
    text-align: center;
    background-color: #f4f4f4;
}

.container {
    max-width: 600px;
    margin: auto;
    padding: 20px;
    background: white;
    box-shadow: 0px 0px 10px rgba(0, 0, 0, 0.1);
    border-radius: 5px;
}

input, button {
    display: block;
    margin: 10px auto;
    padding: 10px;
    width: 90%;
}

button {
    background-color: #28a745;
    color: white;
    border: none;
    cursor: pointer;
}

button:hover {
    background-color: #218838;
}

#disconnectWallet {
    background-color: #dc3545;
}

#disconnectWallet:hover {
    background-color: #c82333;
}
        
.nav-button {
    background-color: #28a745;
    color: white;
    border: none;
    cursor: pointer;
    width: 80px; /* Ukuran tombol lebih pendek */
    padding: 8px;
    display: inline-block;
    margin: 5px;
}

.button-container {
    display: flex;
    gap: 10px; /* Jarak antar tombol */
}

#userBets {
    text-align: justify; /* Meratakan teks seperti di buku */
    hyphens: auto; /* Menambahkan pemenggalan kata jika perlu */
    line-height: 1.6; /* Jarak antar baris agar lebih nyaman dibaca */
    max-width: 600px; /* Batasi lebar agar tidak terlalu panjang */
    margin: auto; /* Pusatkan jika diperlukan */
}
    </style>
</head>
<body>
    <div class="container">
        <h1>Bet History DApp</h1>
        
        <!-- Wallet Connection -->
        <button id="connectWallet" onclick="connectWallet()">Connect Wallet</button>
        <button id="disconnectWallet" onclick="disconnectWallet()" style="display:none;">Disconnect</button>
        <p id="walletAddress"></p>

        <h2>1. Place Bet</h2>
        <input type="text" id="betNumber" placeholder="Enter number (1-4 digits)">
        <input type="number" id="betTimes" placeholder="Times" min="1">
        <button onclick="placeBet()">Place Bet</button>
        <p id="betStatus"></p>

        <h2>2. Your Bets</h2>
<div id="userBets"></div>
<div class="button-container">
    <button class="nav-button" onclick="prevUserBets()">Prev</button>
    <button class="nav-button" onclick="nextUserBets()">Next</button>
</div>

<h2>3. Bet History</h2>
<div id="betHistory"></div>
<div class="button-container">
    <button class="nav-button" onclick="prevBetHistory()">Prev</button>
    <button class="nav-button" onclick="nextBetHistory()">Next</button>
    
    </div>

    <script src="script.js"></script>
    <script>
        const contractAddress = "0x410F02E143Ba921FEdda48830d545154F5E809ab";
        const contractABI = [{"inputs":[],"stateMutability":"nonpayable","type":"constructor"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"bytes32","name":"betId","type":"bytes32"},{"indexed":true,"internalType":"address","name":"user","type":"address"}],"name":"BetLiked","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"player","type":"address"},{"indexed":false,"internalType":"bytes32","name":"betId","type":"bytes32"},{"indexed":false,"internalType":"string","name":"number","type":"string"},{"indexed":false,"internalType":"uint256","name":"betAmount","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"timestamp","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"blockNumber","type":"uint256"},{"indexed":false,"internalType":"bytes32","name":"txHash","type":"bytes32"}],"name":"BetPlaced","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"uint256","name":"drawId","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"winningNumber","type":"uint256"}],"name":"BetResultSet","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"bytes32","name":"betId","type":"bytes32"},{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":false,"internalType":"string","name":"comment","type":"string"},{"indexed":false,"internalType":"uint256","name":"timestamp","type":"uint256"}],"name":"CommentAdded","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"bytes32","name":"betId","type":"bytes32"},{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":false,"internalType":"uint256","name":"commentIndex","type":"uint256"}],"name":"CommentDeleted","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"bytes32","name":"betId","type":"bytes32"},{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":false,"internalType":"uint256","name":"commentIndex","type":"uint256"},{"indexed":false,"internalType":"string","name":"newComment","type":"string"}],"name":"CommentUpdated","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"winner","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"}],"name":"ETHClaimed","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"winner","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"}],"name":"WinnerSet","type":"event"},{"inputs":[{"internalType":"bytes32","name":"betId","type":"bytes32"},{"internalType":"string","name":"_comment","type":"string"}],"name":"addComment","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"bytes32","name":"","type":"bytes32"},{"internalType":"uint256","name":"","type":"uint256"}],"name":"betComments","outputs":[{"internalType":"address","name":"commenter","type":"address"},{"internalType":"string","name":"text","type":"string"},{"internalType":"uint256","name":"timestamp","type":"uint256"},{"internalType":"bool","name":"isDeleted","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"betHistory","outputs":[{"internalType":"address","name":"player","type":"address"},{"internalType":"string","name":"number","type":"string"},{"internalType":"uint256","name":"betAmount","type":"uint256"},{"internalType":"uint256","name":"timestamp","type":"uint256"},{"internalType":"uint256","name":"blockNumber","type":"uint256"},{"internalType":"bytes32","name":"txHash","type":"bytes32"},{"internalType":"bool","name":"isETH","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"bytes32","name":"","type":"bytes32"},{"internalType":"address","name":"","type":"address"}],"name":"betLikes","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"betPrice","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"betResults","outputs":[{"internalType":"uint256","name":"drawId","type":"uint256"},{"internalType":"uint256","name":"winningNumber","type":"uint256"},{"internalType":"bool","name":"isProcessed","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"claimETH","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"contractBalance","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"bytes32","name":"betId","type":"bytes32"},{"internalType":"uint256","name":"commentIndex","type":"uint256"}],"name":"deleteComment","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"bytes32","name":"betId","type":"bytes32"},{"internalType":"uint256","name":"commentIndex","type":"uint256"},{"internalType":"string","name":"newComment","type":"string"}],"name":"editComment","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"getAllBets","outputs":[{"components":[{"internalType":"address","name":"player","type":"address"},{"internalType":"string","name":"number","type":"string"},{"internalType":"uint256","name":"betAmount","type":"uint256"},{"internalType":"uint256","name":"timestamp","type":"uint256"},{"internalType":"uint256","name":"blockNumber","type":"uint256"},{"internalType":"bytes32","name":"txHash","type":"bytes32"},{"internalType":"bool","name":"isETH","type":"bool"}],"internalType":"struct BetHistory.Bet[]","name":"","type":"tuple[]"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"bytes32","name":"betId","type":"bytes32"}],"name":"getComments","outputs":[{"components":[{"internalType":"address","name":"commenter","type":"address"},{"internalType":"string","name":"text","type":"string"},{"internalType":"uint256","name":"timestamp","type":"uint256"},{"internalType":"bool","name":"isDeleted","type":"bool"}],"internalType":"struct BetHistory.Comment[]","name":"","type":"tuple[]"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"_user","type":"address"}],"name":"getUserBets","outputs":[{"components":[{"internalType":"address","name":"player","type":"address"},{"internalType":"string","name":"number","type":"string"},{"internalType":"uint256","name":"betAmount","type":"uint256"},{"internalType":"uint256","name":"timestamp","type":"uint256"},{"internalType":"uint256","name":"blockNumber","type":"uint256"},{"internalType":"bytes32","name":"txHash","type":"bytes32"},{"internalType":"bool","name":"isETH","type":"bool"}],"internalType":"struct BetHistory.Bet[]","name":"","type":"tuple[]"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"bytes32","name":"betId","type":"bytes32"}],"name":"likeBet","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"maxBet","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"minBet","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"owner","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"string","name":"_number","type":"string"},{"internalType":"uint256","name":"_times","type":"uint256"},{"internalType":"bool","name":"_isETH","type":"bool"}],"name":"placeBet","outputs":[],"stateMutability":"payable","type":"function"},{"inputs":[{"internalType":"uint256","name":"_drawId","type":"uint256"},{"internalType":"uint256","name":"_winningNumber","type":"uint256"}],"name":"setBetResult","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"_winner","type":"address"},{"internalType":"uint256","name":"_amount","type":"uint256"}],"name":"setWinner","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"},{"internalType":"uint256","name":"","type":"uint256"}],"name":"userBets","outputs":[{"internalType":"address","name":"player","type":"address"},{"internalType":"string","name":"number","type":"string"},{"internalType":"uint256","name":"betAmount","type":"uint256"},{"internalType":"uint256","name":"timestamp","type":"uint256"},{"internalType":"uint256","name":"blockNumber","type":"uint256"},{"internalType":"bytes32","name":"txHash","type":"bytes32"},{"internalType":"bool","name":"isETH","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"winnings","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"_amount","type":"uint256"}],"name":"withdrawETH","outputs":[],"stateMutability":"nonpayable","type":"function"},{"stateMutability":"payable","type":"receive"}];
        const betPrice = 0.000175;

        let web3;
let contract;
let userAccount;
let userBetsPage = 0;
let betHistoryPage = 0;
const pageSize = 5;

// **Connect Wallet**
async function connectWallet() {
    if (window.ethereum) {
        try {
            web3 = new Web3(window.ethereum);
            await window.ethereum.request({ method: "eth_requestAccounts" });
            const accounts = await web3.eth.getAccounts();
            userAccount = accounts[0];
            contract = new web3.eth.Contract(contractABI, contractAddress);

            document.getElementById("walletAddress").innerText = `Connected: ${userAccount}`;
            document.getElementById("connectWallet").style.display = "none";
            document.getElementById("disconnectWallet").style.display = "block";

            loadUserBets();
            loadBetHistory();
        } catch (error) {
            console.error(error);
            alert("Connection failed!");
        }
    } else {
        alert("Please install MetaMask!");
    }
}

// **Disconnect Wallet**
function disconnectWallet() {
    userAccount = null;
    document.getElementById("walletAddress").innerText = "Disconnected";
    document.getElementById("connectWallet").style.display = "block";
    document.getElementById("disconnectWallet").style.display = "none";
}

// **Place Bet**
async function placeBet() {
    if (!userAccount) {
        alert("Please connect your wallet first!");
        return;
    }

    const number = document.getElementById("betNumber").value;
    const times = parseInt(document.getElementById("betTimes").value);
    const betPrice = web3.utils.toWei("0.000175", "ether");
    const totalCost = betPrice * times;

    if (!number || number.length < 1 || number.length > 4 || isNaN(times) || times < 1) {
        alert("Invalid bet input!");
        return;
    }

    try {
        await contract.methods.placeBet(number, times, true).send({
            from: userAccount,
            value: totalCost
        });
        document.getElementById("betStatus").innerText = "Bet placed successfully!";
        loadUserBets();
    } catch (error) {
        console.error(error);
        document.getElementById("betStatus").innerText = "Transaction failed!";
    }
}

// **Load User Bets (with Pagination)**
async function loadUserBets() {
    if (!userAccount) return;
    const bets = await contract.methods.getUserBets(userAccount).call();
    const reversedBets = bets.slice().reverse(); // Membalik urutan bets agar yang terbaru di atas

    const start = userBetsPage * pageSize;
    const end = Math.min(start + pageSize, reversedBets.length);

    let html = "";
    for (let i = start; i < end; i++) {
        html += `<p>
            Player: ${reversedBets[i].player}<br>
            BetNumber: ${reversedBets[i].number}<br>
            BetAmount: ${reversedBets[i].betAmount}<br>
            Tx: ${reversedBets[i].txHash}<br>
            Block: <a href="https://basescan.io/block/${reversedBets[i].blockNumber}" target="_blank">${reversedBets[i].blockNumber}</a><br>
            Status: ${reversedBets[i].status ? reversedBets[i].status : 'Pending'}<br>
            Time: ${new Date(reversedBets[i].timestamp * 1000).toISOString()} UTC<br>
        </p><hr>`;
    }
    document.getElementById("userBets").innerHTML = html;
}
        
// **User Bets Pagination**
function prevUserBets() {
    if (userBetsPage > 0) {
        userBetsPage--;
        loadUserBets();
    }
}

function nextUserBets() {
    userBetsPage++;
    loadUserBets();
}

// **Load Bet History (with Pagination)**
async function loadBetHistory() {
    const bets = await contract.methods.getAllBets().call();
    const reversedBets = bets.slice().reverse(); // Membalik urutan bets

    const start = betHistoryPage * pageSize;
    const end = Math.min(start + pageSize, reversedBets.length);

    let html = "";
    for (let i = start; i < end; i++) {
        html += `<p>
            Player: ${reversedBets[i].player}<br>
            BetNumber: ${reversedBets[i].number}<br>
            BetAmount: ${reversedBets[i].betAmount}<br>
            Tx: ${reversedBets[i].txHash}<br>
            Block: <a href="https://basescan.io/block/${reversedBets[i].blockNumber}" target="_blank">${reversedBets[i].blockNumber}</a><br>
            Status: ${reversedBets[i].status ? reversedBets[i].status : 'Pending'}<br>
            Time: ${new Date(reversedBets[i].timestamp * 1000).toISOString()} UTC<br>
        </p><hr>`;
    }
    document.getElementById("betHistory").innerHTML = html;
}

// **Bet History Pagination**
function prevBetHistory() {
    if (betHistoryPage > 0) {
        betHistoryPage--;
        loadBetHistory();
    }
}

function nextBetHistory() {
    betHistoryPage++;
    loadBetHistory();
}

// Initialize saat halaman terbuka
window.onload = () => {
    if (window.ethereum) {
        window.ethereum.on("accountsChanged", (accounts) => {
            if (accounts.length > 0) {
                userAccount = accounts[0];
                document.getElementById("walletAddress").innerText = `Connected: ${userAccount}`;
                document.getElementById("connectWallet").style.display = "none";
                document.getElementById("disconnectWallet").style.display = "block";
                loadUserBets();
                loadBetHistory();
            } else {
                disconnectWallet();
            }
        });
    }
};
    </script>
</body>
</html>
