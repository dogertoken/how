<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bet History DApp</title>
    <link rel="stylesheet" href="styles.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/web3/4.0.2/web3.min.js"></script>
    <script defer src="app.js"></script>
    <style>
        .wallet-section {
    margin-bottom: 20px;
}

.wallet-section button {
    padding: 10px;
    margin: 5px;
    cursor: pointer;
}

#connectWalletBtn {
    background: #007bff;
    color: white;
    border: none;
}

#disconnectWalletBtn {
    background: #dc3545;
    color: white;
    border: none;
}

.wallet-section p {
    font-weight: bold;
        }
    </style>
</head>
<body>
    <h1>Bet History DApp</h1>

    <!-- Tombol Connect Wallet -->
    <div class="wallet-section">
        <button id="connectWalletBtn" onclick="connectWallet()">Connect Wallet</button>
        <button id="disconnectWalletBtn" onclick="disconnectWallet()" style="display:none;">Disconnect</button>
        <p id="walletAddress"></p>
    </div>

    <!-- Form Place Bet -->
    <div class="bet-form">
        <h2>Place a Bet</h2>
        <input type="text" id="betNumber" placeholder="Enter number (1-4 digits)">
        <input type="number" id="betTimes" placeholder="Bet Amount" min="1">
        <button onclick="placeBet()">Place Bet</button>
    </div>

    <!-- Riwayat Taruhan Pengguna -->
    <div class="history-section">
        <h2>Your Bets</h2>
        <table id="userBetsTable">
            <thead>
                <tr>
                    <th>Number</th>
                    <th>Amount</th>
                    <th>Timestamp</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
        <div class="pagination" id="userBetsPagination"></div>
    </div>

    <!-- Riwayat Semua Taruhan -->
    <div class="history-section">
        <h2>All Bets</h2>
        <table id="allBetsTable">
            <thead>
                <tr>
                    <th>Player</th>
                    <th>Number</th>
                    <th>Amount</th>
                    <th>Timestamp</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
        <div class="pagination" id="allBetsPagination"></div>
    </div>

    <script>
        const contractAddress = "0x410F02E143Ba921FEdda48830d545154F5E809ab"; // Ganti dengan alamat kontrak Anda
const abi = [{"inputs":[],"stateMutability":"nonpayable","type":"constructor"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"bytes32","name":"betId","type":"bytes32"},{"indexed":true,"internalType":"address","name":"user","type":"address"}],"name":"BetLiked","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"player","type":"address"},{"indexed":false,"internalType":"bytes32","name":"betId","type":"bytes32"},{"indexed":false,"internalType":"string","name":"number","type":"string"},{"indexed":false,"internalType":"uint256","name":"betAmount","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"timestamp","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"blockNumber","type":"uint256"},{"indexed":false,"internalType":"bytes32","name":"txHash","type":"bytes32"}],"name":"BetPlaced","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"uint256","name":"drawId","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"winningNumber","type":"uint256"}],"name":"BetResultSet","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"bytes32","name":"betId","type":"bytes32"},{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":false,"internalType":"string","name":"comment","type":"string"},{"indexed":false,"internalType":"uint256","name":"timestamp","type":"uint256"}],"name":"CommentAdded","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"bytes32","name":"betId","type":"bytes32"},{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":false,"internalType":"uint256","name":"commentIndex","type":"uint256"}],"name":"CommentDeleted","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"bytes32","name":"betId","type":"bytes32"},{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":false,"internalType":"uint256","name":"commentIndex","type":"uint256"},{"indexed":false,"internalType":"string","name":"newComment","type":"string"}],"name":"CommentUpdated","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"winner","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"}],"name":"ETHClaimed","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"winner","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"}],"name":"WinnerSet","type":"event"},{"inputs":[{"internalType":"bytes32","name":"betId","type":"bytes32"},{"internalType":"string","name":"_comment","type":"string"}],"name":"addComment","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"bytes32","name":"","type":"bytes32"},{"internalType":"uint256","name":"","type":"uint256"}],"name":"betComments","outputs":[{"internalType":"address","name":"commenter","type":"address"},{"internalType":"string","name":"text","type":"string"},{"internalType":"uint256","name":"timestamp","type":"uint256"},{"internalType":"bool","name":"isDeleted","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"betHistory","outputs":[{"internalType":"address","name":"player","type":"address"},{"internalType":"string","name":"number","type":"string"},{"internalType":"uint256","name":"betAmount","type":"uint256"},{"internalType":"uint256","name":"timestamp","type":"uint256"},{"internalType":"uint256","name":"blockNumber","type":"uint256"},{"internalType":"bytes32","name":"txHash","type":"bytes32"},{"internalType":"bool","name":"isETH","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"bytes32","name":"","type":"bytes32"},{"internalType":"address","name":"","type":"address"}],"name":"betLikes","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"betPrice","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"betResults","outputs":[{"internalType":"uint256","name":"drawId","type":"uint256"},{"internalType":"uint256","name":"winningNumber","type":"uint256"},{"internalType":"bool","name":"isProcessed","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"claimETH","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"contractBalance","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"bytes32","name":"betId","type":"bytes32"},{"internalType":"uint256","name":"commentIndex","type":"uint256"}],"name":"deleteComment","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"bytes32","name":"betId","type":"bytes32"},{"internalType":"uint256","name":"commentIndex","type":"uint256"},{"internalType":"string","name":"newComment","type":"string"}],"name":"editComment","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"getAllBets","outputs":[{"components":[{"internalType":"address","name":"player","type":"address"},{"internalType":"string","name":"number","type":"string"},{"internalType":"uint256","name":"betAmount","type":"uint256"},{"internalType":"uint256","name":"timestamp","type":"uint256"},{"internalType":"uint256","name":"blockNumber","type":"uint256"},{"internalType":"bytes32","name":"txHash","type":"bytes32"},{"internalType":"bool","name":"isETH","type":"bool"}],"internalType":"struct BetHistory.Bet[]","name":"","type":"tuple[]"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"bytes32","name":"betId","type":"bytes32"}],"name":"getComments","outputs":[{"components":[{"internalType":"address","name":"commenter","type":"address"},{"internalType":"string","name":"text","type":"string"},{"internalType":"uint256","name":"timestamp","type":"uint256"},{"internalType":"bool","name":"isDeleted","type":"bool"}],"internalType":"struct BetHistory.Comment[]","name":"","type":"tuple[]"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"_user","type":"address"}],"name":"getUserBets","outputs":[{"components":[{"internalType":"address","name":"player","type":"address"},{"internalType":"string","name":"number","type":"string"},{"internalType":"uint256","name":"betAmount","type":"uint256"},{"internalType":"uint256","name":"timestamp","type":"uint256"},{"internalType":"uint256","name":"blockNumber","type":"uint256"},{"internalType":"bytes32","name":"txHash","type":"bytes32"},{"internalType":"bool","name":"isETH","type":"bool"}],"internalType":"struct BetHistory.Bet[]","name":"","type":"tuple[]"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"bytes32","name":"betId","type":"bytes32"}],"name":"likeBet","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"maxBet","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"minBet","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"owner","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"string","name":"_number","type":"string"},{"internalType":"uint256","name":"_times","type":"uint256"},{"internalType":"bool","name":"_isETH","type":"bool"}],"name":"placeBet","outputs":[],"stateMutability":"payable","type":"function"},{"inputs":[{"internalType":"uint256","name":"_drawId","type":"uint256"},{"internalType":"uint256","name":"_winningNumber","type":"uint256"}],"name":"setBetResult","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"_winner","type":"address"},{"internalType":"uint256","name":"_amount","type":"uint256"}],"name":"setWinner","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"},{"internalType":"uint256","name":"","type":"uint256"}],"name":"userBets","outputs":[{"internalType":"address","name":"player","type":"address"},{"internalType":"string","name":"number","type":"string"},{"internalType":"uint256","name":"betAmount","type":"uint256"},{"internalType":"uint256","name":"timestamp","type":"uint256"},{"internalType":"uint256","name":"blockNumber","type":"uint256"},{"internalType":"bytes32","name":"txHash","type":"bytes32"},{"internalType":"bool","name":"isETH","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"winnings","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"_amount","type":"uint256"}],"name":"withdrawETH","outputs":[],"stateMutability":"nonpayable","type":"function"},{"stateMutability":"payable","type":"receive"}];
const betPrice = 0.000175; 
let web3;
let contract;
let userAccount;

// Fungsi Connect Wallet
async function connectWallet() {
    if (window.ethereum) {
        web3 = new Web3(window.ethereum);
        try {
            const accounts = await window.ethereum.request({ method: "eth_requestAccounts" });
            userAccount = accounts[0];
            document.getElementById("walletAddress").innerText = `Connected: ${shortenAddress(userAccount)}`;
            document.getElementById("connectWalletBtn").style.display = "none";
            document.getElementById("disconnectWalletBtn").style.display = "inline-block";
            contract = new web3.eth.Contract(abi, contractAddress);
            loadUserBets();
            loadAllBets();
        } catch (error) {
            console.error("Wallet connection failed", error);
            alert("Failed to connect wallet.");
        }
    } else {
        alert("Please install MetaMask to use this DApp.");
    }
}

// Fungsi Disconnect Wallet
function disconnectWallet() {
    userAccount = null;
    document.getElementById("walletAddress").innerText = "";
    document.getElementById("connectWalletBtn").style.display = "inline-block";
    document.getElementById("disconnectWalletBtn").style.display = "none";
}

// Fungsi Memperpendek Alamat Wallet
function shortenAddress(address) {
    return address.slice(0, 6) + "..." + address.slice(-4);
}

// Fungsi Place Bet
async function placeBet() {
    if (!userAccount) {
        alert("Please connect your wallet first.");
        return;
    }

    const betNumber = document.getElementById("betNumber").value;
    const betTimes = document.getElementById("betTimes").value;

    if (!betNumber || isNaN(betTimes) || betTimes < 1) {
        alert("Invalid input");
        return;
    }

    const totalCost = web3.utils.toWei((betTimes * 0.000175).toString(), "ether");

    try {
        await contract.methods.placeBet(betNumber, betTimes, true)
            .send({ from: userAccount, value: totalCost });
        alert("Bet placed successfully!");
        loadUserBets();
    } catch (error) {
        console.error("Transaction failed", error);
        alert("Transaction failed.");
    }
}

// Load Riwayat Taruhan Pengguna
async function loadUserBets(page = 1, perPage = 5) {
    if (!userAccount) return;
    const bets = await contract.methods.getUserBets(userAccount).call();
    displayBets("userBetsTable", "userBetsPagination", bets, page, perPage);
}

// Load Riwayat Semua Taruhan
async function loadAllBets(page = 1, perPage = 5) {
    const bets = await contract.methods.getAllBets().call();
    displayBets("allBetsTable", "allBetsPagination", bets, page, perPage);
}

// Fungsi Menampilkan Data dengan Pagination
function displayBets(tableId, paginationId, bets, page, perPage) {
    const tableBody = document.querySelector(`#${tableId} tbody`);
    tableBody.innerHTML = "";

    const start = (page - 1) * perPage;
    const end = start + perPage;
    const paginatedBets = bets.slice(start, end);

    paginatedBets.forEach(bet => {
        const row = tableBody.insertRow();
        row.insertCell(0).innerText = bet.number;
        row.insertCell(1).innerText = bet.betAmount;
        row.insertCell(2).innerText = new Date(bet.timestamp * 1000).toLocaleString();
    });

    setupPagination(paginationId, bets.length, page, perPage, tableId);
}

// Fungsi Setup Pagination
function setupPagination(paginationId, totalItems, currentPage, perPage, tableId) {
    const totalPages = Math.ceil(totalItems / perPage);
    const pagination = document.getElementById(paginationId);
    pagination.innerHTML = "";

    if (totalPages > 1) {
        pagination.innerHTML += `<button onclick="load${tableId.replace("Table", "")}(1)">First</button>`;
        pagination.innerHTML += `<button onclick="load${tableId.replace("Table", "")}(${Math.max(1, currentPage - 1)})">Prev</button>`;

        for (let i = 1; i <= totalPages; i++) {
            pagination.innerHTML += `<button onclick="load${tableId.replace("Table", "")}(${i})">${i}</button>`;
        }

        pagination.innerHTML += `<button onclick="load${tableId.replace("Table", "")}(${Math.min(totalPages, currentPage + 1)})">Next</button>`;
        pagination.innerHTML += `<button onclick="load${tableId.replace("Table", "")}(${totalPages})">Last</button>`;
    }
        }
    </script>

</body>
</html>
