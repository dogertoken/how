<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fair Lottery</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.jsdelivr.net/npm/web3/dist/web3.min.js"></script>
    <style>
        body {
    font-family: Arial, sans-serif;
    text-align: center;
    background-color: #f4f4f4;
}

h1 {
    color: #333;
}

button {
    padding: 10px 20px;
    margin: 10px;
    border: none;
    background-color: #28a745;
    color: white;
    cursor: pointer;
}

button:hover {
    background-color: #218838;
}

p {
    font-size: 18px;
}
    </style>
</head>
<body>
    <h1>Fair Lottery</h1>

    <button id="connectWallet">Connect Wallet</button>
    <button id="disconnectWallet" style="display:none;">Disconnect</button>

    <p><strong>Wallet:</strong> <span id="walletAddress">Not Connected</span></p>
    <p><strong>Saldo USDT:</strong> <span id="usdtBalance">0</span> USDT</p>

    <label for="lotteryType">Pilih Jenis Lotre:</label>
    <select id="lotteryType">
        <option value="0">Harian</option>
        <option value="1">Mingguan</option>
        <option value="2">Bulanan</option>
    </select>

    <div>
        <button id="buyTicket">Beli Tiket</button>
        <button id="commitNumber">Commit Nomor</button>
        <button id="revealNumber">Reveal Nomor</button>
        <button id="finalizeLottery">Finalisasi Lotre</button>
    </div>

    <h2>Info Lotre</h2>
    <p><strong>Jackpot:</strong> <span id="jackpot">0</span> USDT</p>
    <p><strong>Peserta:</strong> <span id="participants">0</span></p>
    <p><strong>Pemenang Terakhir:</strong> <span id="winner">-</span></p>

    <script src="appjs"></script>
    <script>
        const contractAddress = "0x1234567890abcdef1234567890abcdef12345678"; // Ganti dengan alamat kontrak
const contractABI = [ /* ABI Kontrak */ ];
const usdtContractAddress = "0xYOUR_USDT_CONTRACT_ADDRESS"; // Ganti dengan alamat kontrak USDT
const usdtABI = [ /* ABI USDT ERC20 */ ];

let web3;
let lotteryContract;
let usdtContract;
let userAccount = null;

// ðŸ”¹ Inisialisasi Web3 dan Kontrak
async function initWeb3() {
    if (window.ethereum) {
        web3 = new Web3(window.ethereum);
        lotteryContract = new web3.eth.Contract(contractABI, contractAddress);
        usdtContract = new web3.eth.Contract(usdtABI, usdtContractAddress);
    } else {
        alert("Metamask tidak terdeteksi! Silakan install.");
    }
}

// ðŸ”¹ Connect Wallet
async function connectWallet() {
    try {
        if (!window.ethereum) return alert("Metamask tidak tersedia!");

        await window.ethereum.request({ method: "eth_requestAccounts" });
        const accounts = await web3.eth.getAccounts();
        userAccount = accounts[0];

        document.getElementById("walletAddress").innerText = userAccount;
        document.getElementById("connectWallet").style.display = "none";
        document.getElementById("disconnectWallet").style.display = "inline";

        updateUSDTBalance();
        updateLotteryInfo();
    } catch (error) {
        console.error(error);
        alert("Gagal menghubungkan wallet!");
    }
}

// ðŸ”¹ Disconnect Wallet
function disconnectWallet() {
    userAccount = null;
    document.getElementById("walletAddress").innerText = "Not Connected";
    document.getElementById("usdtBalance").innerText = "0";
    document.getElementById("connectWallet").style.display = "inline";
    document.getElementById("disconnectWallet").style.display = "none";
}

// ðŸ”¹ Update Saldo USDT
async function updateUSDTBalance() {
    if (!userAccount) return;
    
    try {
        const balance = await usdtContract.methods.balanceOf(userAccount).call();
        document.getElementById("usdtBalance").innerText = web3.utils.fromWei(balance, "mwei");
    } catch (error) {
        console.error("Gagal mengambil saldo USDT:", error);
    }
}

// ðŸ”¹ Membeli Tiket Lotre
async function buyTicket() {
    if (!userAccount) return alert("Silakan connect wallet dulu!");

    const lotteryType = document.getElementById("lotteryType").value;
    const ticketPrice = await lotteryContract.methods.lotteries(lotteryType).call();
    const priceWei = ticketPrice.ticketPrice;

    try {
        await usdtContract.methods.approve(contractAddress, priceWei).send({ from: userAccount });
        await lotteryContract.methods.buyTicket(lotteryType, web3.utils.keccak256("salt123")).send({ from: userAccount });

        alert("Tiket berhasil dibeli!");
        updateUSDTBalance();
        updateLotteryInfo();
    } catch (error) {
        console.error(error);
        alert("Gagal membeli tiket!");
    }
}

// ðŸ”¹ Commit Nomor Lotre
async function commitNumber() {
    if (!userAccount) return alert("Silakan connect wallet dulu!");

    const lotteryType = document.getElementById("lotteryType").value;
    const randomNumber = Math.floor(Math.random() * 100000);
    const salt = web3.utils.randomHex(32);
    const commitment = web3.utils.keccak256(web3.eth.abi.encodeParameters(["bytes32", "uint256"], [salt, randomNumber]));

    try {
        await lotteryContract.methods.commitNumber(lotteryType, commitment).send({ from: userAccount });

        localStorage.setItem("salt", salt);
        localStorage.setItem("randomNumber", randomNumber);
        alert("Nomor berhasil di-commit!");
    } catch (error) {
        console.error(error);
        alert("Gagal commit nomor!");
    }
}

// ðŸ”¹ Reveal Nomor Lotre
async function revealNumber() {
    if (!userAccount) return alert("Silakan connect wallet dulu!");

    const lotteryType = document.getElementById("lotteryType").value;
    const salt = localStorage.getItem("salt");
    const randomNumber = localStorage.getItem("randomNumber");

    if (!salt || !randomNumber) {
        alert("Anda belum commit nomor!");
        return;
    }

    try {
        await lotteryContract.methods.revealNumber(lotteryType, randomNumber, salt).send({ from: userAccount });
        alert("Nomor berhasil di-reveal!");
    } catch (error) {
        console.error(error);
        alert("Gagal reveal nomor!");
    }
}

// ðŸ”¹ Finalisasi Lotre
async function finalizeLottery() {
    if (!userAccount) return alert("Silakan connect wallet dulu!");

    const lotteryType = document.getElementById("lotteryType").value;
    
    try {
        await lotteryContract.methods.finalizeLottery(lotteryType).send({ from: userAccount });
        alert("Lotre berhasil difinalisasi!");
        updateLotteryInfo();
    } catch (error) {
        console.error(error);
        alert("Gagal finalisasi lotre!");
    }
}

// ðŸ”¹ Update Info Lotre
async function updateLotteryInfo() {
    if (!userAccount) return;

    try {
        const lotteryType = document.getElementById("lotteryType").value;
        const lotteryData = await lotteryContract.methods.lotteries(lotteryType).call();

        document.getElementById("jackpot").innerText = lotteryData.jackpot;
        document.getElementById("participants").innerText = lotteryData.participants.length;
        document.getElementById("winner").innerText = "Menunggu finalisasi...";
    } catch (error) {
        console.error(error);
    }
}

// ðŸ”¹ Tambahkan Event Listener ke Tombol
document.getElementById("connectWallet").addEventListener("click", connectWallet);
document.getElementById("disconnectWallet").addEventListener("click", disconnectWallet);
document.getElementById("buyTicket").addEventListener("click", buyTicket);
document.getElementById("commitNumber").addEventListener("click", commitNumber);
document.getElementById("revealNumber").addEventListener("click", revealNumber);
document.getElementById("finalizeLottery").addEventListener("click", finalizeLottery);

// ðŸ”¹ Inisialisasi Web3 saat halaman dimuat
window.onload = initWeb3;
    </script>
</body>
</html>
