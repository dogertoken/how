<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FairLottery</title>
    <link rel="stylesheet" href="stylecss">
    <script src="https://cdn.jsdelivr.net/npm/web3/dist/web3.min.js"></script>
    <style>
        body {
    font-family: Arial, sans-serif;
    text-align: center;
    background-color: #f4f4f4;
}

h1 {
    color: #333;
}

button {
    padding: 10px 20px;
    margin: 10px;
    border: none;
    background-color: #28a745;
    color: white;
    cursor: pointer;
}

button:hover {
    background-color: #218838;
}

p {
    font-size: 18px;
}
    </style>
</head>
<body>
    <h1>Fair Lottery</h1>

    <button id="connectWallet" onclick="connectWallet()">Connect Wallet</button>
    <button id="disconnectWallet" onclick="disconnectWallet()" style="display:none;">Disconnect</button>

    <p><strong>Wallet:</strong> <span id="walletAddress">Not Connected</span></p>
    <p><strong>Saldo USDT:</strong> <span id="usdtBalance">0</span> USDT</p>

    <label for="lotteryType">Pilih Jenis Lotre:</label>
    <select id="lotteryType">
        <option value="0">Harian</option>
        <option value="1">Mingguan</option>
        <option value="2">Bulanan</option>
    </select>

    <div>
        <button onclick="buyTicket()">Beli Tiket</button>
        <button onclick="commitNumber()">Commit Nomor</button>
        <button onclick="revealNumber()">Reveal Nomor</button>
        <button onclick="finalizeLottery()">Finalisasi Lotre</button>
    </div>

    <h2>Info Lotre</h2>
    <p><strong>Jackpot:</strong> <span id="jackpot">0</span> USDT</p>
    <p><strong>Peserta:</strong> <span id="participants">0</span></p>
    <p><strong>Pemenang Terakhir:</strong> <span id="winner">-</span></p>

    <script src="app.js"></script>
    <style>
        const contractAddress = "0x1234567890abcdef1234567890abcdef12345678"; // Ganti dengan alamat kontrak
const contractABI = [ /* Masukkan ABI kontrak di sini */ ];
const usdtContractAddress = "0xYOUR_USDT_CONTRACT_ADDRESS"; // Ganti dengan alamat USDT di jaringan yang dipakai
const usdtABI = [ /* ABI USDT ERC20 */ ];

let web3;
let lotteryContract;
let usdtContract;
let userAccount = null;

// ðŸ”¹ Connect Wallet
async function connectWallet() {
    if (window.ethereum) {
        web3 = new Web3(window.ethereum);
        await window.ethereum.request({ method: "eth_requestAccounts" });
        const accounts = await web3.eth.getAccounts();
        userAccount = accounts[0];

        document.getElementById("walletAddress").innerText = userAccount;
        document.getElementById("connectWallet").style.display = "none";
        document.getElementById("disconnectWallet").style.display = "inline";

        lotteryContract = new web3.eth.Contract(contractABI, contractAddress);
        usdtContract = new web3.eth.Contract(usdtABI, usdtContractAddress);

        updateUSDTBalance();
        updateLotteryInfo();
    } else {
        alert("Metamask tidak terdeteksi! Silakan install.");
    }
}

// ðŸ”¹ Disconnect Wallet
function disconnectWallet() {
    userAccount = null;
    document.getElementById("walletAddress").innerText = "Not Connected";
    document.getElementById("usdtBalance").innerText = "0";
    document.getElementById("connectWallet").style.display = "inline";
    document.getElementById("disconnectWallet").style.display = "none";
}

// ðŸ”¹ Update Saldo USDT
async function updateUSDTBalance() {
    if (!userAccount) return;
    
    const balance = await usdtContract.methods.balanceOf(userAccount).call();
    document.getElementById("usdtBalance").innerText = web3.utils.fromWei(balance, "mwei");
}

// ðŸ”¹ Membeli Tiket Lotre
async function buyTicket() {
    if (!userAccount) return alert("Silakan connect wallet dulu!");

    const lotteryType = document.getElementById("lotteryType").value;
    const ticketPrice = await lotteryContract.methods.lotteries(lotteryType).call();
    const priceWei = ticketPrice.ticketPrice;

    await usdtContract.methods.approve(contractAddress, priceWei).send({ from: userAccount });
    await lotteryContract.methods.buyTicket(lotteryType, web3.utils.keccak256("salt123")).send({ from: userAccount });

    alert("Tiket berhasil dibeli!");
    updateUSDTBalance();
    updateLotteryInfo();
}

// ðŸ”¹ Commit Nomor Lotre
async function commitNumber() {
    if (!userAccount) return alert("Silakan connect wallet dulu!");

    const lotteryType = document.getElementById("lotteryType").value;
    const randomNumber = Math.floor(Math.random() * 100000); // Nomor lotre 0-99999
    const salt = web3.utils.randomHex(32);
    const commitment = web3.utils.keccak256(web3.eth.abi.encodeParameters(["bytes32", "uint256"], [salt, randomNumber]));

    await lotteryContract.methods.commitNumber(lotteryType, commitment).send({ from: userAccount });

    localStorage.setItem("salt", salt);
    localStorage.setItem("randomNumber", randomNumber);
    alert("Nomor berhasil di-commit!");
}

// ðŸ”¹ Reveal Nomor Lotre
async function revealNumber() {
    if (!userAccount) return alert("Silakan connect wallet dulu!");

    const lotteryType = document.getElementById("lotteryType").value;
    const salt = localStorage.getItem("salt");
    const randomNumber = localStorage.getItem("randomNumber");

    if (!salt || !randomNumber) {
        alert("Anda belum commit nomor!");
        return;
    }

    await lotteryContract.methods.revealNumber(lotteryType, randomNumber, salt).send({ from: userAccount });
    alert("Nomor berhasil di-reveal!");
}

// ðŸ”¹ Finalisasi Lotre
async function finalizeLottery() {
    if (!userAccount) return alert("Silakan connect wallet dulu!");

    const lotteryType = document.getElementById("lotteryType").value;
    await lotteryContract.methods.finalizeLottery(lotteryType).send({ from: userAccount });

    alert("Lotre berhasil difinalisasi!");
    updateLotteryInfo();
}

// ðŸ”¹ Update Info Lotre
async function updateLotteryInfo() {
    if (!userAccount) return;

    const lotteryType = document.getElementById("lotteryType").value;
    const lotteryData = await lotteryContract.methods.lotteries(lotteryType).call();

    document.getElementById("jackpot").innerText = lotteryData.jackpot;
    document.getElementById("participants").innerText = lotteryData.participants.length;
    document.getElementById("winner").innerText = "Menunggu finalisasi...";
}

window.onload = connectWallet;
    </style>
</body>
</html>
